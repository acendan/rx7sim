import{G as Be,C as rt,M as we,D as at,a as de,V as b,Q as lt,S as Ne,b as ct,c as $e,d as J,B as Xe,L as dt,e as ut,R as ft,f as ue,g as We,P as pt,A as gt,h as ht,i as mt,j as yt,k as bt,l as Ke,F as xt,m as vt,n as wt,o as He,p as Et,H as Ct,q as Lt,r as St,W as Ft,s as Rt,t as At,E as Tt,u as Mt,O as kt,v as Ot,w as Pt,x as It,y as le,z as Ge,I as Wt,J as Ht,K as zt}from"./vendor-D4_FRbEO.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&o(r)}).observe(document,{childList:!0,subtree:!0});function i(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(n){if(n.ep)return;n.ep=!0;const s=i(n);fetch(n.href,s)}})();const V={STOP:"stop",DRIVE:"drive",ACCEL:"accel",DECEL:"decel"},oe={MIX:"mix",INTAKE:"intake",EXHAUST:"exhaust",INTERIOR:"interior"},N={MIX:10507946,INTAKE:5152511,EXHAUST:10289023,INTERIOR:16771220},Ee={MIX:.8,INTAKE:.5,EXHAUST:.8,INTERIOR:.3},P={innerAngle:45,outerAngle:120,outerGain:.3},F={ambient:{color:16777215,intensity:.5},hemisphere:{skyColor:16777215,groundColor:9276813,intensity:.4},directional:[{color:16711661,intensity:1},{color:16775154,intensity:1},{color:16318207,intensity:.2}]},Qe={Garage:{path:"./hdri/garage.hdr",reverb:"Garage",lighting:{ambient:{color:15790320,intensity:.2},hemisphere:{skyColor:12632256,groundColor:3815994,intensity:.15},directional:[{color:12375295,intensity:1.5},{color:16768426,intensity:.5},{color:8947848,intensity:.1}]}},Track:{path:"./hdri/track.hdr",reverb:"Outdoors",lighting:{ambient:{color:16774803,intensity:.25},hemisphere:{skyColor:13428479,groundColor:5921370,intensity:.15},directional:[{color:16777215,intensity:.1},{color:16773841,intensity:.1},{color:11193599,intensity:0}]}}};function Dt(){try{const e=document.createElement("canvas"),t=e.getContext("webgl")||e.getContext("experimental-webgl");if(!t)return{available:!1,error:"WebGL is not supported by your browser or graphics driver."};const i=["OES_element_index_uint"];for(const o of i)if(!t.getExtension(o))return{available:!1,error:`WebGL extension ${o} is not supported.`};return{available:!0,error:null}}catch(e){return{available:!1,error:`WebGL check failed: ${e.message}`}}}function Vt(){try{return window.AudioContext||window.webkitAudioContext?{available:!0,error:null}:{available:!1,error:"Web Audio API is not supported by your browser."}}catch(e){return{available:!1,error:`Web Audio API check failed: ${e.message}`}}}function U(e,t,i=!0){const o=document.getElementById("error-overlay");o&&o.remove();const n=document.createElement("div");n.id="error-overlay",Object.assign(n.style,{position:"fixed",top:"0",left:"0",width:"100%",height:"100%",backgroundColor:i?"rgba(0, 0, 0, 0.95)":"rgba(0, 0, 0, 0.7)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:"99999",fontFamily:"system-ui, -apple-system, sans-serif",color:"#fff",padding:"20px",boxSizing:"border-box"});const s=document.createElement("div");Object.assign(s.style,{maxWidth:"500px",backgroundColor:"#1a1a1a",borderRadius:"12px",padding:"32px",boxShadow:"0 8px 32px rgba(0, 0, 0, 0.5)",border:"1px solid #333"});const r=document.createElement("h2");r.textContent=e,Object.assign(r.style,{margin:"0 0 16px 0",fontSize:"24px",fontWeight:"600",color:"#ff6b6b"});const d=document.createElement("p");if(d.textContent=t,Object.assign(d.style,{margin:"0 0 24px 0",fontSize:"16px",lineHeight:"1.6",color:"#ccc"}),s.appendChild(r),s.appendChild(d),!i){const c=document.createElement("button");c.textContent="Dismiss",Object.assign(c.style,{backgroundColor:"#444",color:"#fff",border:"none",borderRadius:"6px",padding:"12px 24px",fontSize:"14px",cursor:"pointer",fontWeight:"500"}),c.addEventListener("click",()=>n.remove()),c.addEventListener("mouseenter",()=>c.style.backgroundColor="#555"),c.addEventListener("mouseleave",()=>c.style.backgroundColor="#444"),s.appendChild(c)}n.appendChild(s),document.body.appendChild(n)}function Nt(e="Loading..."){const t=document.getElementById("loading-overlay");t&&t.remove();const i=document.createElement("div");i.id="loading-overlay",Object.assign(i.style,{position:"fixed",top:"0",left:"0",width:"100%",height:"100%",backgroundColor:"rgba(0, 0, 0, 0.9)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:"99998",fontFamily:"system-ui, -apple-system, sans-serif",color:"#fff"});const o=document.createElement("div");Object.assign(o.style,{textAlign:"center"});const n=document.createElement("div");Object.assign(n.style,{width:"50px",height:"50px",margin:"0 auto 20px",border:"4px solid #333",borderTop:"4px solid #fff",borderRadius:"50%",animation:"spin 1s linear infinite"});const s=document.createElement("div");if(s.textContent=e,Object.assign(s.style,{fontSize:"16px",color:"#ccc"}),!document.getElementById("spinner-style")){const r=document.createElement("style");r.id="spinner-style",r.textContent=`
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `,document.head.appendChild(r)}return o.appendChild(n),o.appendChild(s),i.appendChild(o),document.body.appendChild(i),{update:r=>{s.textContent=r},remove:()=>{i.remove()}}}function Ce(e,t,i=null){return new Promise((o,n)=>{e.load(t,s=>{console.log(`✓ Loaded model: ${t}`),o(s)},i,s=>{console.error(`✗ Failed to load model: ${t}`,s),n(new Error(`Failed to load model ${t}: ${s.message}`))})})}function ye(e,t){return new Promise((i,o)=>{e.load(t,n=>{console.log(`✓ Loaded audio: ${t}`),i(n)},null,n=>{console.error(`✗ Failed to load audio: ${t}`,n),o(new Error(`Failed to load audio ${t}: ${n.message}`))})})}function $t(e,t){return new Promise((i,o)=>{e.load(t,n=>{console.log(`✓ Loaded HDR: ${t}`),i(n)},null,n=>{console.error(`✗ Failed to load HDR: ${t}`,n),o(new Error(`Failed to load HDR ${t}: ${n.message}`))})})}function fe(e){if(e){if(e.children)for(let t=e.children.length-1;t>=0;t--)fe(e.children[t]);e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(t=>_e(t)):_e(e.material)),e.renderTarget&&e.renderTarget.dispose(),e.parent&&e.parent.remove(e)}}function _e(e){e&&(Object.keys(e).forEach(t=>{const i=e[t];i&&typeof i=="object"&&"minFilter"in i&&i.dispose()}),e.dispose())}function Me(e){if(e)try{e.dispose()}catch(t){console.error("Failed to dispose texture:",t)}}function Gt(e){if(e)try{if(e.isPlaying&&e.stop(),e._reverbNodes){const{dryGain:t,wetGain:i,convolver:o}=e._reverbNodes;try{t.disconnect(),i.disconnect(),o.disconnect()}catch(n){console.warn("Error disconnecting reverb nodes:",n)}e._reverbNodes=null}e.disconnect(),e.buffer=null}catch(t){console.error("Failed to dispose audio emitter:",t)}}function _t({color:e=16777215,intensity:t=1,mapSize:i=1024,far:o=15,bounds:n={left:-7,right:7,top:7,bottom:-7},position:s=[5,3,4]}={}){const r=new ct(e,t);return r.castShadow=!0,r.shadow.mapSize.set(i,i),r.shadow.camera.far=o,r.shadow.camera.left=n.left,r.shadow.camera.right=n.right,r.shadow.camera.top=n.top,r.shadow.camera.bottom=n.bottom,r.position.set(...s),r}function qt(e=[]){return e.map(t=>_t(t))}function ne(e){if(typeof e=="string"){if(e.startsWith("#")&&(e.length===7||e.length===9))return e.slice(0,7);try{const t=Number(e);if(!Number.isNaN(t))return`#${(t>>>0).toString(16).padStart(6,"0")}`}catch{}return e}return`#${(e>>>0).toString(16).padStart(6,"0")}`}function jt(e,{size:t=.2,color:i=16776960,showCone:o=!1,coneAngle:n=P.innerAngle,coneDirection:s=new b(0,0,1)}={}){const r=new Be;if(o){const d=t*3,c=J.degToRad(n),a=Math.tan(c)*d,u=new rt(a,d,16,1,!0),y=new we({color:i,wireframe:!0,transparent:!0,opacity:.6,side:at}),f=new de(u,y),p=new b(0,-1,0),h=new lt;h.setFromUnitVectors(p,s.clone().normalize()),f.quaternion.copy(h),f.position.copy(s.clone().normalize().multiplyScalar(d/2)),r.add(f);const m=new Ne(t*.3),L=new we({color:i,transparent:!0,opacity:.9}),S=new de(m,L);r.add(S)}else{const d=new Ne(t),c=new we({color:i,wireframe:!0,transparent:!0,opacity:.8}),a=new de(d,c);r.add(a)}return r.position.copy(e.position),r}function Ut({color:e=16777182,intensity:t=3,distance:i=10,angle:o=Math.PI/6,penumbra:n=.5,decay:s=1,leftPosition:r=[.75,.76,1.8],rightPosition:d=[-.75,.76,1.8],targetPosition:c=[0,0,10]}={}){const a=new $e(e,t,i,o,n,s);a.position.set(...r),a.target.position.set(...c),a.castShadow=!0,a.shadow.mapSize.width=1024,a.shadow.mapSize.height=1024,a.shadow.camera.near=.5,a.shadow.camera.far=20,a.shadow.camera.fov=30;const u=new $e(e,t,i,o,n,s);return u.position.set(...d),u.target.position.set(...c),u.castShadow=!0,u.shadow.mapSize.width=1024,u.shadow.mapSize.height=1024,u.shadow.camera.near=.5,u.shadow.camera.far=20,u.shadow.camera.fov=30,{left:a,right:u}}function Le(e,t,i,{store:o=null,storeKey:n=null,loop:s=!1,refDistance:r=20,volume:d=null,offset:c=0,onEnded:a=null}={}){const u=y=>{try{t.stop(),t.setBuffer(y),t.setRefDistance(r),t.setLoop(s),typeof d=="number"&&t.setVolume&&t.setVolume(d),a&&(t.onEnded=a),t.play()}catch(f){console.error("Failed to play positional audio:",f)}};if(o&&n&&o[n]){u(o[n]);return}ye(e,i).then(y=>{o&&n&&(o[n]=y),u(y)}).catch(y=>{console.error("Failed to load and play audio:",i,y)})}function Se({screenAnchor:e=new ue(-.9,.9),targetLocalPos:t=new b(0,0,0),targetObject:i=null,label:o="btn",color:n=65280}={}){const s=[new b,new b],r=new Xe().setFromPoints(s),d=new dt({color:n}),c=new ut(r,d);c.set;let a=null;typeof document<"u"&&(a=document.createElement("button"),a.color=n,a.dimmed=!1,a.className="three-linebutton",a.style.position="absolute",a.style.padding="4px 12px",a.style.border="none",a.style.borderRadius="12px",a.style.backgroundColor=ne(n),a.style.color="#272727ff",a.style.fontFamily="sans-serif",a.style.fontSize="14px",a.style.cursor="pointer",a.style.transform="translate(-50%, -50%)",a.style.boxShadow="0 2px 2px rgba(255, 255, 255, 0.24)",a.style.userSelect="none",a.textContent=o,document.body.appendChild(a),a.addEventListener("mouseenter",()=>{a.style.backgroundColor=ne(Math.min(n*4,16777215))}),a.addEventListener("mouseleave",()=>{a.style.backgroundColor=a.dimmed?"#444444":ne(n)}));const u=new ft;let y=!0;const f=new b,p=new b,h=new b,m=new b,L=new b,S=new b,O=new b;let ae=null,X=null,Ve=0;function ot(T){if((Ve%30===0||!ae)&&(ae=document.querySelector("canvas.webgl"),ae&&(X=ae.getBoundingClientRect())),Ve++,f.set(e.x,e.y,.5),f.unproject(T),p.copy(f).sub(T.position).normalize(),h.copy(T.position).add(p.multiplyScalar(1)),i?(m.copy(t),i.localToWorld(m)):m.copy(t),L.copy(m).sub(T.position).normalize(),u.set(T.position,L),S.copy(m),i){const Z=u.intersectObject(i,!0);Z&&Z.length>0&&S.copy(Z[0].point)}const ve=c.geometry.attributes.position;if(ve.setXYZ(0,h.x,h.y,h.z),ve.setXYZ(1,S.x,S.y,S.z),ve.needsUpdate=!0,a&&X)if(O.copy(h).project(T),!y||O.z>1||O.z<-1||O.x<-1.2||O.x>1.2||O.y<-1.2||O.y>1.2)a.style.display="none";else{a.style.display="";const Z=(O.x*.5+.5)*X.width+X.left,st=(-O.y*.5+.5)*X.height+X.top;a.style.left=`${Z}px`,a.style.top=`${st}px`}}function nt(T){y=T,c.visible=T,a&&(a.style.display=T?"":"none")}function it(){a&&a.parentElement&&(a.removeEventListener("mouseenter",null),a.removeEventListener("mouseleave",null),a.parentElement.removeChild(a),a=null),c.geometry&&c.geometry.dispose(),c.material&&c.material.dispose()}return{line:c,button:a,update:ot,setVisible:nt,dispose:it}}const be=1e3,W=new Xe,pe=new Float32Array(be*3),ee=new Float32Array(be*4),Ye=new Float32Array(be);W.setAttribute("position",new We(pe,3));W.setAttribute("color",new We(ee,4));W.setAttribute("size",new We(Ye,1));const ke=new pt({size:.1,vertexColors:!0,transparent:!0,opacity:.5,blending:gt}),Bt=new ht(W,ke),M={pool:[],active:[],acquire(){let e;return this.pool.length>0?e=this.pool.pop():e={offset:[0,0,0],scale:[0,0],quaternion:[0,0,0,0],rotation:0,color:[1,1,1,1],blend:0,texture:0,live:0,scaleIncrease:0,opacityDecrease:0,colorFrom:[0,0,0],colorTo:[0,0,0],colorSpeed:0,colorProgress:0},this.active.push(e),e},release(e){const t=this.active.indexOf(e);t>-1&&(this.active.splice(t,1),this.pool.push(e))},getActiveCount(){return this.active.length},clear(){for(;this.active.length>0;)this.pool.push(this.active.pop())}},H={emitters:[],enabled:!0,visible:!0,initialize:()=>{const e={enabled:!1,position:new b(-.5,.3,-2),settings:{radius1:.02,radius2:.1,radiusHeight:.2,addTime:.02,elapsed:0,liveTimeFrom:1,liveTimeTo:1.5,opacityDecrease:.008,rotationFrom:.5,rotationTo:1,speedFrom:.003,speedTo:.006,scaleFrom:.1,scaleIncrease:.002,colorFrom:[.9,.9,.9],colorTo:[.5,.5,.5],colorSpeedFrom:1,colorSpeedTo:1,brightnessFrom:.5,brightnessTo:.9,opacity:.6,blend:.8,texture:.5}};H.emitters.push(e)},update:(e,t)=>{H.emitters.forEach(o=>{if(t!=="stop"?(o.enabled=!0,o.settings.addTime=t==="accel"?.01:.02,o.settings.speedFrom=t==="accel"?.005:.003,o.settings.speedTo=t==="accel"?.008:.006):o.enabled=!1,o.enabled){let n=0;for(o.settings.elapsed+=e,n=Math.floor(o.settings.elapsed/o.settings.addTime),o.settings.elapsed-=n*o.settings.addTime;n--&&!(M.getActiveCount()>=be);){const s=M.acquire(),r=o.settings.radius1*Math.sqrt(Math.random()),d=2*Math.PI*Math.random(),c=o.position.x+r*Math.cos(d),a=o.position.z+r*Math.sin(d),u=o.settings.radius2*Math.sqrt(Math.random()),y=c+u*Math.cos(d),f=a+u*Math.sin(d),p=new b(y-c,o.settings.radiusHeight,f-a).normalize(),h=Math.random()*(o.settings.speedTo-o.settings.speedFrom)+o.settings.speedFrom;p.multiplyScalar(h);const m=Math.random()*(o.settings.brightnessTo-o.settings.brightnessFrom)+o.settings.brightnessFrom;s.offset[0]=c,s.offset[1]=o.position.y,s.offset[2]=a,s.scale[0]=o.settings.scaleFrom,s.scale[1]=o.settings.scaleFrom,s.quaternion[0]=p.x,s.quaternion[1]=p.y,s.quaternion[2]=p.z,s.quaternion[3]=3,s.rotation=Math.random()*(o.settings.rotationTo-o.settings.rotationFrom)+o.settings.rotationFrom,s.color[0]=1,s.color[1]=1,s.color[2]=1,s.color[3]=o.settings.opacity,s.blend=o.settings.blend,s.texture=o.settings.texture,s.live=Math.random()*(o.settings.liveTimeTo-o.settings.liveTimeFrom)+o.settings.liveTimeFrom,s.scaleIncrease=o.settings.scaleIncrease,s.opacityDecrease=o.settings.opacityDecrease,s.colorFrom[0]=o.settings.colorFrom[0]*m,s.colorFrom[1]=o.settings.colorFrom[1]*m,s.colorFrom[2]=o.settings.colorFrom[2]*m,s.colorTo[0]=o.settings.colorTo[0]*m,s.colorTo[1]=o.settings.colorTo[1]*m,s.colorTo[2]=o.settings.colorTo[2]*m,s.colorSpeed=Math.random()*(o.settings.colorSpeedTo-o.settings.colorSpeedFrom)+o.settings.colorSpeedFrom,s.colorProgress=0}}});const i=M.active;for(let o=i.length-1;o>=0;o--){const n=i[o];if(n.offset[0]+=n.quaternion[0],n.offset[1]+=n.quaternion[1],n.offset[2]+=n.quaternion[2],n.scale[0]+=n.scaleIncrease,n.scale[1]+=n.scaleIncrease,n.colorProgress+=n.colorSpeed,n.colorProgress>1&&(n.colorProgress=1),n.color[0]=n.colorFrom[0]+(n.colorTo[0]-n.colorFrom[0])*n.colorProgress,n.color[1]=n.colorFrom[1]+(n.colorTo[1]-n.colorFrom[1])*n.colorProgress,n.color[2]=n.colorFrom[2]+(n.colorTo[2]-n.colorFrom[2])*n.colorProgress,n.color[3]-=n.opacityDecrease,n.live-=e,n.live<=0||n.color[3]<=0){M.release(n);continue}const s=o*3;pe[s]=n.offset[0],pe[s+1]=n.offset[1],pe[s+2]=n.offset[2];const r=o*4;ee[r]=n.color[0],ee[r+1]=n.color[1],ee[r+2]=n.color[2],ee[r+3]=n.color[3],Ye[o]=n.scale[0]}M.getActiveCount()>0&&(W.attributes.position.needsUpdate=!0,W.attributes.color.needsUpdate=!0,W.attributes.size.needsUpdate=!0)},getMesh:()=>Bt,dispose:()=>{M.clear(),W&&W.dispose(),ke&&ke.dispose(),H.emitters.length=0},getStats:()=>({activeParticles:M.getActiveCount(),pooledParticles:M.pool.length,totalAllocated:M.active.length+M.pool.length})};function Xt({emitters:e={},initialVisible:t=!1}={}){let i=t,o=null;const n=new Map;function s(){return o||(o=document.createElement("div"),o.id="audio-volume-panel",Object.assign(o.style,{position:"fixed",bottom:"10px",right:"10px",padding:"8px",background:"rgba(0,0,0,0.6)",color:"#fff",borderRadius:"6px",zIndex:9999,fontFamily:"monospace",fontSize:"12px",pointerEvents:"none",display:i?"":"none"}),document.body.appendChild(o),o)}function r(f){const p=document.createElement("div");p.dataset.pos=f,Object.assign(p.style,{display:"flex",alignItems:"center",marginBottom:"6px",pointerEvents:"auto",flexDirection:"row"});const h=document.createElement("div");h.className="vol-label",h.textContent=f,Object.assign(h.style,{width:"70px",textTransform:"capitalize"});const m=document.createElement("div");m.className="vol-bar-container",Object.assign(m.style,{width:"64px",height:"12px",background:"rgba(255,255,255,0.08)",borderRadius:"3px",display:"flex",alignItems:"center",overflow:"hidden",marginLeft:"8px",marginRight:"8px"});const L=document.createElement("div");L.className="vol-bar",Object.assign(L.style,{width:"0%",height:"100%",background:"#666",transition:"width 0.08s linear"});const S=f.toUpperCase();return N[S]!==void 0&&(L.style.background=ne(N[S])),m.appendChild(L),p.appendChild(h),p.appendChild(m),p}function d(f,p){if(!n.has(f)&&p?.getOutput()){const h=new mt(p,32);n.set(f,h)}return n.get(f)}function c(f,p){const h=d(f,p);if(!h)return 0;const m=h.getAverageFrequency()/255,L=p&&p.getVolume?p.getVolume():0;return m*L}function a(){const f=s();Object.entries(e).forEach(([p,h])=>{if(p==="mix")return;let m=f.querySelector(`[data-pos="${p}"]`);m||(m=r(p),f.appendChild(m));const L=c(p,h)*3,S=m.querySelector(".vol-bar");S.style.width=`${Math.max(0,Math.min(1,L))*100}%`}),o.style.display=i?"":"none"}function u(f){i=!!f,o&&(o.style.display=i?"":"none")}function y(){n.forEach(f=>{if(f&&f.analyser)try{f.analyser.disconnect()}catch(p){console.warn("Error disposing analyser:",p)}}),n.clear(),o&&o.parentElement&&(o.parentElement.removeChild(o),o=null)}return{update:a,setVisible:u,isVisible:()=>i,dispose:y}}function Kt({initialVisible:e=!1}={}){let t=null,i=e,o=!1,n=null;function s(u){n=u}function r(){if(t)return t;t=document.createElement("div"),t.id="controls-panel",Object.assign(t.style,{position:"fixed",top:"10px",left:"10px",padding:"8px",background:"rgba(0,0,0,0.0)",color:"#fff",borderRadius:"6px",zIndex:9999,fontFamily:"monospace",fontSize:"12px",pointerEvents:"none",display:i?"":"none",border:"none"});const u=document.createElement("button");u.className="ignition-toggle",u.innerHTML=`
            <span class="ignition-start" style="font-weight:bold;color:#fff;">START</span>
            <span class="ignition-stop" style="color:#aaa;">STOP</span>
        `,Object.assign(u.style,{display:"block",margin:"4px 0",padding:"0",width:"75px",height:"75px",borderRadius:"50%",background:"radial-gradient(circle at 60% 40%, #a00 80%, #cc2f2f 100%)",border:"2px solid #fff",boxShadow:"0 2px 8px rgba(0,0,0,0.4)",cursor:"pointer",color:"#fff",fontFamily:"inherit",fontSize:"16px",textAlign:"center",lineHeight:"16px",position:"relative",transition:"background 0.2s"});function y(){const f=u.querySelector(".ignition-start"),p=u.querySelector(".ignition-stop");o?(f.style.fontWeight="normal",f.style.color="#888",p.style.fontWeight="bold",p.style.color="#fff",u.style.background="radial-gradient(circle at 60% 40%, #cc2f2f 80%, #a00 100%)"):(f.style.fontWeight="bold",f.style.color="#fff",p.style.fontWeight="normal",p.style.color="#888",u.style.background="radial-gradient(circle at 60% 40%, #a00 80%, #cc2f2f 100%)"),n&&n(o)}return u.addEventListener("click",()=>{o=!o,y()}),t.style.pointerEvents="auto",t.appendChild(u),document.body.appendChild(t),t}function d(){r(),t.style.display=i?"":"none"}function c(u){i=!!u,t&&(t.style.display=i?"":"none")}function a(){t&&t.parentElement&&(t.parentElement.removeChild(t),t=null)}return{registerIgnitionCallback:s,update:d,setVisible:c,isVisible:()=>i,dispose:a}}function Qt({initialVisible:e=!1}={}){let t=e,i=null,o=0,n=performance.now(),s=0,r=0;function d(){return i||(i=document.createElement("div"),i.id="performance-stats",Object.assign(i.style,{position:"fixed",bottom:"10px",left:"10px",padding:"8px",background:"rgba(0,0,0,0.6)",color:"#fff",borderRadius:"6px",zIndex:9999,fontFamily:"monospace",fontSize:"12px",pointerEvents:"none",display:t?"":"none",minWidth:"120px"}),document.body.appendChild(i),i)}function c(){o++;const y=performance.now(),f=y-n;if(f>=1e3&&(s=Math.round(o*1e3/f),r=f/o,o=0,n=y),t){const p=d();let h="#00ff00";s<60&&(h="#ffff00"),s<30&&(h="#ff0000"),p.innerHTML=`
                <div style="margin-bottom: 4px;">
                    <span style="color: #888;">FPS:</span> 
                    <span style="color: ${h}; font-weight: bold;">${s}</span>
                </div>
                <div>
                    <span style="color: #888;">Frame:</span> 
                    <span>${r.toFixed(2)}ms</span>
                </div>
            `}}function a(y){t=!!y,i&&(i.style.display=t?"":"none")}function u(){i&&i.parentElement&&(i.parentElement.removeChild(i),i=null)}return{update:c,setVisible:a,isVisible:()=>t,dispose:u,getStats:()=>({fps:s,frameTime:r})}}yt.enabled=!1;var K=V.STOP,ge=oe.MIX;const Fe=Dt();if(!Fe.available)throw U("WebGL Not Supported",Fe.error,!0),new Error(Fe.error);const Re=Vt();if(!Re.available)throw U("Web Audio Not Supported",Re.error,!0),new Error(Re.error);const $={modelsLoaded:!1,audioLoaded:!1,sceneReady:!1},Ze=document.querySelector("canvas.webgl"),g=new bt;g.background=new Ke(10526880);g.fog=new xt(15716789,.05);const re=new vt,ie={Meters:!0,Emitters:!1},xe=re.addFolder("Audio");let te=null;const ze=re.addFolder("Vehicle"),Yt=re.addFolder("Performance"),Zt={"Show Stats":!1},Ae=new wt,ce=new He,Jt=new Et;new Ct;const B=new de(new Lt(10,10),new St({color:"#444444",metalness:0,roughness:.5}));B.receiveShadow=!0;B.rotation.x=-Math.PI*.5;g.add(B);const Te=g.background?g.background.clone():new Ke(10526880);let I=null;const eo=["None",...Object.keys(Qe)],to={HDR:"None"};ze.add(to,"HDR",eo).name("Level Select").onChange(e=>{if(e==="None"){I&&(Me(I),I=null),g.background=Te.clone?Te.clone():Te,g.environment=null,B.visible=!0,qe(null),g.fog&&(g.fog.color.set(15716789),g.fog.density=.05),typeof x.toneMappingExposure=="number"&&(x.toneMappingExposure=E.exposure),g.traverse(n=>{n.isMesh&&n.material&&(Array.isArray(n.material)?n.material.forEach(s=>s.needsUpdate=!0):n.material.needsUpdate=!0)}),console.log("[HDR Reset] Ambient",A.intensity,A.color.getHexString()),Y.forEach((n,s)=>console.log(`[HDR Reset] Dir${s}`,n.intensity,n.color.getHexString())),console.log("[HDR Reset] Hemi",w.intensity,w.color.getHexString(),w.groundColor.getHexString()),C.removeConvolutionReverb(),he.Reverb="None",te&&te.updateDisplay();return}const t=Qe[e];if(!t)return;const i=typeof t=="string"?t:t.path,o=typeof t=="object"?t.reverb:null;$t(Jt,i).then(n=>{if(I&&Me(I),n.mapping=Tt,I=n,g.background=n,g.environment=n,B.visible=!1,t.lighting&&qe(t.lighting),o&&he&&(he.Reverb=o,te)){te.updateDisplay();const s=Pe[o];if(s){const{path:r,blend:d=.5,scalingFactor:c=1}=s;C.currentReverbBlend=d,C.currentReverbScalingFactor=c,ye(new He,r).then(a=>{C.applyConvolutionReverb(a)}).catch(a=>{console.error("Failed to load reverb:",a),U("Reverb Load Failed",`Could not load reverb: ${a.message}`,!1)})}}}).catch(n=>{console.error("Failed to load HDR:",n),U("HDR Load Failed",`Could not load environment: ${n.message}`,!1)})});let v=new Be;g.add(v);v.add(H.getMesh());const _=[];let l={mixerWheels:null,actWheelsRot:null,actTiresRot:null,mixerLights:null,actLights0:null,actLights1:null,actLights2:null,actLights3:null,actLights4:null,headLightL:null,headLightR:null,lightsFlipFlop:!0,lightsIntensity:3,lightsTimeScaleToggle:()=>{if(l.mixerLights)if(l.lightsFlipFlop){l.mixerLights.timeScale=1.5;for(let e=0;e<5;e++){const t=`actLights${e}`;l[t]&&(l[t].time=0)}l.lightsFlipFlop=!1}else{l.mixerLights.timeScale=-1.5;for(let e=0;e<5;e++){const t=`actLights${e}`;l[t]&&(l[t].time=l[t].getClip().duration-l[t].time)}l.lightsFlipFlop=!0}},lights:()=>{l.mixerLights&&(l.mixerLights.stopAllAction(),l.lightsTimeScaleToggle(),l.actLights0&&l.actLights0.play(),l.actLights1&&l.actLights1.play(),l.actLights2&&l.actLights2.play(),l.actLights3&&l.actLights3.play(),l.actLights4&&l.actLights4.play())}};async function oo(){const e=Nt("Loading models...");try{e.update("Loading car model...");const[t,i,o]=await Promise.all([Ce(Ae,"./model/rx7/rx7.gltf"),Ce(Ae,"./model/rx7_wheels/rx7_wheels.gltf"),Ce(Ae,"./model/rx7_lights/rx7_lights.gltf")]);e.update("Setting up scene..."),t.scene.scale.set(1,1,1),v.add(t.scene),H.initialize(),i.scene.scale.set(1,1,1),i.scene.position.set(0,0,0),v.add(i.scene);const n=i.scene.clone();n.position.set(0,0,2.45),v.add(n);const s=i.scene.clone();s.position.set(0,0,2.45),s.scale.set(-1,1,1),v.add(s);const r=i.scene.clone();r.position.set(0,0,0),r.scale.set(-1,1,1),v.add(r),l.mixerWheels=new Ge(new Wt(i.scene,n,s,r)),l.actWheelsRot=l.mixerWheels.clipAction(i.animations[0]),l.actTiresRot=l.mixerWheels.clipAction(i.animations[1]),o.scene.scale.set(1,1,1),v.add(o.scene),l.mixerLights=new Ge(o.scene);for(let a=0;a<5;a++){const u=`actLights${a}`;l[u]=l.mixerLights.clipAction(o.animations[a]),l[u].setLoop(Ht),l[u].clampWhenFinished=!0}const{left:d,right:c}=Ut({intensity:l.lightsIntensity});l.headLightL=d,l.headLightR=c,v.add(l.headLightL),v.add(l.headLightL.target),v.add(l.headLightR),v.add(l.headLightR.target),ze.add(l,"lights").name("Headlights"),no(t.scene),$.modelsLoaded=!0,e.remove(),console.log("✓ All models loaded successfully")}catch(t){e.remove(),console.error("Failed to load models:",t),U("Failed to Load Models",`Could not load required 3D models. Please check your connection and refresh the page.

Error: ${t.message}`,!1)}}function no(e){const t=Se({screenAnchor:new ue(-.5,-.8),targetLocalPos:new b(0,.2,2.1),targetObject:e,label:"Intake",color:N.INTAKE}),i=Se({screenAnchor:new ue(.5,-.8),targetLocalPos:new b(-.5,.3,-2),targetObject:e,label:"Exhaust",color:N.EXHAUST}),o=Se({screenAnchor:new ue(0,-.8),targetLocalPos:new b(0,.1,-.2),targetObject:e,label:"Interior",color:N.INTERIOR});[t,i,o].forEach(s=>{g.add(s.line),_.push(s),s.button.addEventListener("click",()=>{oe[s.button.textContent.toUpperCase()]===ge?(ge=oe.MIX,_.forEach(r=>{r!==s&&(r.button.style.backgroundColor=ne(N[r.button.textContent.toUpperCase()]),r.button.style.color="#272727ff",r.line.visible=!0,r.button.dimmed=!1)}),ie.Emitters&&j.forEach(r=>r.visible=!0)):(ge=oe[s.button.textContent.toUpperCase()],_.forEach(r=>{if(r!==s){if(r.button.style.backgroundColor="#444444",r.button.style.color="#888888",r.line.visible=!1,r.button.dimmed=!0,ie.Emitters){const d=r.button.textContent.toLowerCase(),c=j.get(d);c&&(c.visible=!1)}}else if(r.button.style.color="#272727ff",r.line.visible=!0,r.button.dimmed=!1,ie.Emitters){const d=r.button.textContent.toLowerCase(),c=j.get(d);c&&(c.visible=!0)}}))})});const n={"Solo Buttons":!0};xe.add(n,"Solo Buttons").onChange(s=>{t.setVisible(s),i.setVisible(s),o.setVisible(s)})}oo().then(()=>{Oe()}).catch(e=>{console.error("Critical error during model initialization:",e)});function Oe(){$.modelsLoaded&&$.audioLoaded&&!$.sceneReady&&($.sceneReady=!0,console.log("✓ Scene fully initialized and ready"))}const w=new At(F.hemisphere.skyColor,F.hemisphere.groundColor,F.hemisphere.intensity);w.position.set(0,100,0);g.add(w);const A=new Rt(F.ambient.color,F.ambient.intensity);g.add(A);const Y=qt([{color:F.directional[0].color,intensity:F.directional[0].intensity,position:[5,3,4]},{color:F.directional[1].color,intensity:F.directional[1].intensity,position:[8,3,-1]},{color:F.directional[2].color,intensity:F.directional[2].intensity,position:[-5,5,-5]}]);Y.forEach(e=>g.add(e));let E=null;function Je(){E={ambient:{color:A.color.getHex(),intensity:A.intensity},hemi:{sky:w.color.getHex(),ground:w.groundColor.getHex(),intensity:w.intensity},directional:Y.map(e=>({color:e.color.getHex(),intensity:e.intensity})),fog:g.fog?{color:g.fog.color.getHex(),density:g.fog.density}:null,exposure:typeof x<"u"&&typeof x.toneMappingExposure=="number"?x.toneMappingExposure:1}}function et(){E||Je(),A.color.setHex(E.ambient.color),A.intensity=E.ambient.intensity,w.color.setHex(E.hemi.sky),w.groundColor.setHex(E.hemi.ground),w.intensity=E.hemi.intensity,Y.forEach((e,t)=>{e.color.setHex(E.directional[t].color),e.intensity=E.directional[t].intensity}),g.fog&&E.fog&&(g.fog.color.setHex(E.fog.color),g.fog.density=E.fog.density),E&&typeof x<"u"&&typeof x.toneMappingExposure=="number"&&(x.toneMappingExposure=E.exposure)}function qe(e){if(!e){et();return}e.ambient&&(e.ambient.color!==void 0&&A.color.setHex(e.ambient.color),e.ambient.intensity!==void 0&&(A.intensity=e.ambient.intensity)),e.hemisphere&&(e.hemisphere.skyColor!==void 0&&w.color.setHex(e.hemisphere.skyColor),e.hemisphere.groundColor!==void 0&&w.groundColor.setHex(e.hemisphere.groundColor),e.hemisphere.intensity!==void 0&&(w.intensity=e.hemisphere.intensity)),e.directional&&Array.isArray(e.directional)&&Y.forEach((t,i)=>{const o=e.directional[i];o&&(o.color!==void 0&&t.color.setHex(o.color),o.intensity!==void 0&&(t.intensity=o.intensity))})}const k={width:window.innerWidth,height:window.innerHeight},io=()=>{k.width=window.innerWidth,k.height=window.innerHeight,D.aspect=k.width/k.height,D.updateProjectionMatrix(),x.setSize(k.width,k.height),x.setPixelRatio(Math.min(window.devicePixelRatio,2))};window.addEventListener("resize",io);const D=new Mt(75,k.width/k.height,.1,100);D.position.set(4,2,3);g.add(D);const De=new kt(D,Ze);De.target.set(0,.75,0);De.enableDamping=!0;const x=new Ft({canvas:Ze});x.outputColorSpace=Ot;x.shadowMap.enabled=!0;x.shadowMap.type=Pt;x.setSize(k.width,k.height);x.setPixelRatio(Math.min(window.devicePixelRatio,2));Je();et();const G=new It;D.add(G);const Q=G.context,R={mix:new le(G),intake:new le(G),exhaust:new le(G),interior:new le(G)};console.log("Audio Emitters:",R);Object.entries(R).forEach(([e,t])=>{switch(v.add(t),e){case"intake":t.position.set(0,.2,2.1),t.setVolume(0),t.setDirectionalCone(J.degToRad(P.innerAngle),J.degToRad(P.outerAngle),P.outerGain);break;case"exhaust":t.position.set(-.5,.3,-2),t.setVolume(0),t.rotation.y=Math.PI,t.setDirectionalCone(J.degToRad(P.innerAngle),J.degToRad(P.outerAngle),P.outerGain);break;case"interior":t.position.set(0,.5,-.2),t.setVolume(0);break;case"mix":t.position.set(0,0,0),t.setVolume(1);break;default:t.position.set(0,0,0);break}});const C={buffers:{mix:{},intake:{ignitionOn:null,idle:null,ignitionOff:null},exhaust:{ignitionOn:null,idle:null,ignitionOff:null},interior:{ignitionOn:null,idle:null,ignitionOff:null}},currentEmitter:null,setEmitterVolumes(e){["intake","exhaust","interior"].forEach(i=>{const o=R[i];if(!o)return;const n=e===oe.MIX?Ee.MIX:i===e?1:0,s=Ee[i.toUpperCase()]!==void 0?Ee[i.toUpperCase()]:1,r=Math.max(0,Math.min(1,n*s)),d=o.getVolume();d<r?o.setVolume(Math.min(r,d+.2)):d>r&&o.setVolume(Math.max(r,d-.2))}),R.mix.setVolume(0)},ignitionOn:()=>{Q.state==="suspended"&&Q.resume().then(()=>{console.log("Audio context enabled via user interaction")}).catch(e=>{console.error("Failed to resume audio context:",e)}),Object.entries(R).forEach(([e,t])=>{e!=="mix"&&Le(ce,t,`./audio/${e}/ignitionOn.ogg`,{store:C.buffers[e],storeKey:"ignitionOn",loop:!1,onEnded:()=>{Le(ce,t,`./audio/${e}/idle.ogg`,{store:C.buffers[e],storeKey:"idle",loop:!0,onEnded:()=>{}})}})}),K=V.ACCEL,l.mixerWheels&&(l.mixerWheels.stopAllAction(),l.actWheelsRot.play(),l.actTiresRot.play(),l.mixerWheels.timeScale=.01)},ignitionOff:()=>{Object.entries(R).forEach(([e,t])=>{e!=="mix"&&Le(ce,t,`./audio/${e}/ignitionOff.ogg`,{store:C.buffers[e],storeKey:"ignitionOff",loop:!1,onEnded:()=>{t.stop()}})}),K=V.DECEL},load(){const e=this,t=[];Object.keys(e.buffers).forEach(i=>{Object.keys(e.buffers[i]).forEach(o=>{const n=ye(ce,`./audio/${i}/${o}.ogg`).then(s=>{e.buffers[i][o]=s}).catch(s=>{console.error(`Failed to load audio ${i}/${o}:`,s)});t.push(n)})}),Promise.all(t).then(()=>{$.audioLoaded=!0,console.log("✓ All audio files loaded"),Oe()}).catch(()=>{$.audioLoaded=!0,U("Audio Load Warning","Some audio files failed to load. The experience may be incomplete.",!1),Oe()})},applyConvolutionReverb(e){const t=this.currentReverbBlend??.5;Object.values(R).forEach(i=>{if(i._reverbNodes){try{const{dryGain:c,wetGain:a,convolver:u}=i._reverbNodes;c.disconnect(),a.disconnect(),u.disconnect()}catch{}i._reverbNodes=null}const o=G.context,n=o.createConvolver();n.buffer=e;const s=o.createGain(),r=o.createGain();s.gain.value=t*this.currentReverbScalingFactor,r.gain.value=(1-t)*this.currentReverbScalingFactor;const d=i.panner;if(!d){console.warn("PositionalAudio panner node missing; cannot apply reverb graph");return}d.connect(r),r.connect(o.destination),d.connect(n),n.connect(s),s.connect(o.destination),i._reverbNodes={convolver:n,wetGain:s,dryGain:r}})},removeConvolutionReverb(){Object.values(R).forEach(e=>{if(e._reverbNodes){try{const{dryGain:t,wetGain:i,convolver:o}=e._reverbNodes;t.disconnect(),i.disconnect(),o.disconnect()}catch(t){console.warn("Error disconnecting reverb nodes:",t)}e._reverbNodes=null}}),this.currentReverbBlend=null,this.currentReverbScalingFactor=null}};C.load();const Pe={Garage:{path:"./audio/ir/garage.ogg",blend:.8,scalingFactor:.33},Outdoors:{path:"./audio/ir/outdoors.ogg",blend:.6,scalingFactor:.2}},he={Reverb:"None"};te=xe.add(he,"Reverb",["None",...Object.keys(Pe)]).name("Conv. Reverb").onChange(e=>{if(e==="None"){C.removeConvolutionReverb();return}const t=Pe[e];if(!t)return;const{path:i,blend:o=.5,scalingFactor:n=1}=t;C.currentReverbBlend=o,C.currentReverbScalingFactor=n,ye(new He,i).then(s=>{C.applyConvolutionReverb(s)}).catch(s=>{console.error("Failed to load reverb:",s),U("Reverb Load Failed",`Could not load reverb preset: ${s.message}`,!1)})});const z=Kt({initialVisible:!0});z.registerIgnitionCallback(e=>{e?(console.log("Ignition ON"),C.ignitionOn()):(console.log("Ignition OFF"),C.ignitionOff())});console.log("Controls panel created",z);const q=Xt({emitters:R,initialVisible:!0});xe.add(ie,"Meters").onChange(e=>q.setVisible(e));const se=Qt({initialVisible:!1});Yt.add(Zt,"Show Stats").onChange(e=>se.setVisible(e));const j=new Map;Object.entries(R).forEach(([e,t])=>{if(e==="mix")return;const i={color:N[e.toUpperCase()]||16776960,size:.4};e==="intake"?(i.showCone=!0,i.coneAngle=P.innerAngle,i.coneDirection=new b(0,0,1)):e==="exhaust"&&(i.showCone=!0,i.coneAngle=P.innerAngle,i.coneDirection=new b(0,0,-1));const o=jt(t,i);o.visible=!1,v.add(o),j.set(e,o)});xe.add(ie,"Emitters").onChange(e=>{j.forEach(t=>t.visible=e)});const je=["Mazda RX-7 FD"];ze.add({car:je[0]},"car",je).name("Car").onChange(e=>{});function so(){console.log("Cleaning up resources..."),me&&(cancelAnimationFrame(me),me=null),_.forEach(e=>{e&&e.dispose&&e.dispose()}),_.length=0,j.forEach(e=>{fe(e)}),j.clear(),z&&z.dispose&&z.dispose(),q&&q.dispose&&q.dispose(),se&&se.dispose&&se.dispose(),Object.values(R).forEach(e=>{Gt(e)}),H&&H.dispose&&H.dispose(),I&&(Me(I),I=null),v&&fe(v),B&&fe(B),l.mixerWheels&&(l.mixerWheels.stopAllAction(),l.mixerWheels=null),l.mixerLights&&(l.mixerLights.stopAllAction(),l.mixerLights=null),w&&g.remove(w),A&&g.remove(A),Y.forEach(e=>{g.remove(e),e.dispose()}),x&&x.dispose(),re&&re.destroy(),console.log("Cleanup complete")}let me=null,Ie=!document.hidden;document.addEventListener("visibilitychange",()=>{Ie=!document.hidden,Ie?(console.log("Tab visible - resuming simulation"),Q&&Q.state==="suspended"&&Q.resume().catch(e=>{console.warn("Failed to resume audio context:",e)})):(console.log("Tab hidden - pausing heavy computations"),Q.suspend())});window.addEventListener("beforeunload",()=>{so()});const ro=new zt;let Ue=0;const tt=()=>{const e=ro.getElapsedTime(),t=e-Ue;if(Ue=e,Ie){if(l.mixerWheels)switch(l.mixerWheels.update(t),K){case V.ACCEL:for(;l.mixerWheels.timeScale<1;)l.mixerWheels.timeScale+=t,l.mixerWheels.timeScale>=1&&(l.mixerWheels.timeScale=1,K=V.DRIVE);break;case V.DECEL:for(;l.mixerWheels.timeScale>0;)l.mixerWheels.timeScale-=t,l.mixerWheels.timeScale<=0&&(l.mixerWheels.timeScale=0,K=V.STOP,l.mixerWheels.stopAllAction());break}if(l.mixerLights&&(l.mixerLights.update(t),l.actLights0&&l.headLightL&&l.headLightR)){const i=l.lightsIntensity-l.actLights0.time/l.actLights0.getClip().duration*l.lightsIntensity;l.headLightL.intensity=l.headLightR.intensity=i}v.position.z=Math.sin(e*2)*.0125,H.update(t,K),_.length>0&&_.forEach(i=>{try{i.update(D)}catch{}}),C.setEmitterVolumes(ge),z&&z.update&&z.update(),q&&q.update&&q.update()}De.update(),se.update(),x.render(g,D),me=window.requestAnimationFrame(tt)};tt();
//# sourceMappingURL=index-BfCqWtfh.js.map
