import{G as it,C as gt,M as Oe,D as ht,a as xe,V as v,Q as mt,S as Ye,b as bt,c as Ze,d as le,B as rt,L as yt,e as xt,R as vt,f as ve,g as qe,P as wt,A as Et,h as Ct,i as Lt,j as kt,k as St,l as st,F as Ft,m as At,n as Rt,o as _e,p as Tt,H as Mt,q as Ot,r as Pt,W as It,s as Ht,t as Dt,E as zt,u as Wt,O as Vt,v as Nt,w as $t,x as Gt,y as be,z as Je,I as Bt,J as jt,K as qt}from"./vendor-D4_FRbEO.js";(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const t of n)if(t.type==="childList")for(const s of t.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function i(n){const t={};return n.integrity&&(t.integrity=n.integrity),n.referrerPolicy&&(t.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?t.credentials="include":n.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function r(n){if(n.ep)return;n.ep=!0;const t=i(n);fetch(n.href,t)}})();const X={STOP:"stop",DRIVE:"drive",ACCEL:"accel",DECEL:"decel"},ue={MIX:"mix",INTAKE:"intake",EXHAUST:"exhaust",INTERIOR:"interior"},K={MIX:10507946,INTAKE:5152511,EXHAUST:10289023,INTERIOR:16771220},Pe={MIX:.8,INTAKE:.5,EXHAUST:.8,INTERIOR:.3},N={innerAngle:45,outerAngle:120,outerGain:.3},R={short:150,medium:300,long:600},I={ambient:{color:16777215,intensity:.5},hemisphere:{skyColor:16777215,groundColor:9276813,intensity:.4},directional:[{color:16711661,intensity:1},{color:16775154,intensity:1},{color:16318207,intensity:.2}]},at={Garage:{path:"./hdri/garage.hdr",reverb:"Garage",lighting:{ambient:{color:15790320,intensity:.2},hemisphere:{skyColor:12632256,groundColor:3815994,intensity:.15},directional:[{color:12375295,intensity:1.5},{color:16768426,intensity:.5},{color:8947848,intensity:.1}]}},Track:{path:"./hdri/track.hdr",reverb:"Outdoors",lighting:{ambient:{color:16774803,intensity:.25},hemisphere:{skyColor:13428479,groundColor:5921370,intensity:.15},directional:[{color:16777215,intensity:.1},{color:16773841,intensity:.1},{color:11193599,intensity:0}]}}};function _t(){try{const e=document.createElement("canvas"),o=e.getContext("webgl")||e.getContext("experimental-webgl");if(!o)return{available:!1,error:"WebGL is not supported by your browser or graphics driver."};const i=["OES_element_index_uint"];for(const r of i)if(!o.getExtension(r))return{available:!1,error:`WebGL extension ${r} is not supported.`};return{available:!0,error:null}}catch(e){return{available:!1,error:`WebGL check failed: ${e.message}`}}}function Ut(){try{return window.AudioContext||window.webkitAudioContext?{available:!0,error:null}:{available:!1,error:"Web Audio API is not supported by your browser."}}catch(e){return{available:!1,error:`Web Audio API check failed: ${e.message}`}}}function te(e,o,i=!0){const r=document.getElementById("error-overlay");r&&r.remove();const n=document.createElement("div");n.id="error-overlay",Object.assign(n.style,{position:"fixed",top:"0",left:"0",width:"100%",height:"100%",backgroundColor:i?"rgba(0, 0, 0, 0.95)":"rgba(0, 0, 0, 0.7)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:"99999",fontFamily:"system-ui, -apple-system, sans-serif",color:"#fff",padding:"20px",boxSizing:"border-box"});const t=document.createElement("div");Object.assign(t.style,{maxWidth:"500px",backgroundColor:"#1a1a1a",borderRadius:"12px",padding:"32px",boxShadow:"0 8px 32px rgba(0, 0, 0, 0.5)",border:"1px solid #333"});const s=document.createElement("h2");s.textContent=e,Object.assign(s.style,{margin:"0 0 16px 0",fontSize:"24px",fontWeight:"600",color:"#ff6b6b"});const c=document.createElement("p");if(c.textContent=o,Object.assign(c.style,{margin:"0 0 24px 0",fontSize:"16px",lineHeight:"1.6",color:"#ccc"}),t.appendChild(s),t.appendChild(c),!i){const d=document.createElement("button");d.textContent="Dismiss",Object.assign(d.style,{backgroundColor:"#444",color:"#fff",border:"none",borderRadius:"6px",padding:"12px 24px",fontSize:"14px",cursor:"pointer",fontWeight:"500"}),d.addEventListener("click",()=>n.remove()),d.addEventListener("mouseenter",()=>d.style.backgroundColor="#555"),d.addEventListener("mouseleave",()=>d.style.backgroundColor="#444"),t.appendChild(d)}n.appendChild(t),document.body.appendChild(n)}function Xt(e="Loading..."){const o=document.getElementById("loading-overlay");o&&o.remove();const i=document.createElement("div");i.id="loading-overlay",Object.assign(i.style,{position:"fixed",top:"0",left:"0",width:"100%",height:"100%",backgroundColor:"rgba(0, 0, 0, 0.9)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:"99998",fontFamily:"system-ui, -apple-system, sans-serif",color:"#fff"});const r=document.createElement("div");Object.assign(r.style,{textAlign:"center"});const n=document.createElement("div");Object.assign(n.style,{width:"50px",height:"50px",margin:"0 auto 20px",border:"4px solid #333",borderTop:"4px solid #fff",borderRadius:"50%",animation:"spin 1s linear infinite"});const t=document.createElement("div");if(t.textContent=e,Object.assign(t.style,{fontSize:"16px",color:"#ccc"}),!document.getElementById("spinner-style")){const s=document.createElement("style");s.id="spinner-style",s.textContent=`
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `,document.head.appendChild(s)}return r.appendChild(n),r.appendChild(t),i.appendChild(r),document.body.appendChild(i),{update:s=>{t.textContent=s},remove:()=>{i.remove()}}}function Ie(e,o,i=null){return new Promise((r,n)=>{e.load(o,t=>{console.log(`âœ“ Loaded model: ${o}`),r(t)},i,t=>{console.error(`âœ— Failed to load model: ${o}`,t),n(new Error(`Failed to load model ${o}: ${t.message}`))})})}function Se(e,o){return new Promise((i,r)=>{e.load(o,n=>{console.log(`âœ“ Loaded audio: ${o}`),i(n)},null,n=>{console.error(`âœ— Failed to load audio: ${o}`,n),r(new Error(`Failed to load audio ${o}: ${n.message}`))})})}function Kt(e,o){return new Promise((i,r)=>{e.load(o,n=>{console.log(`âœ“ Loaded HDR: ${o}`),i(n)},null,n=>{console.error(`âœ— Failed to load HDR: ${o}`,n),r(new Error(`Failed to load HDR ${o}: ${n.message}`))})})}function we(e){if(e){if(e.children)for(let o=e.children.length-1;o>=0;o--)we(e.children[o]);e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(o=>et(o)):et(e.material)),e.renderTarget&&e.renderTarget.dispose(),e.parent&&e.parent.remove(e)}}function et(e){e&&(Object.keys(e).forEach(o=>{const i=e[o];i&&typeof i=="object"&&"minFilter"in i&&i.dispose()}),e.dispose())}function Ne(e){if(e)try{e.dispose()}catch(o){console.error("Failed to dispose texture:",o)}}function Qt(e){if(e)try{if(e.isPlaying&&e.stop(),e._reverbNodes){const{dryGain:o,wetGain:i,convolver:r}=e._reverbNodes;try{o.disconnect(),i.disconnect(),r.disconnect()}catch(n){console.warn("Error disconnecting reverb nodes:",n)}e._reverbNodes=null}e.disconnect(),e.buffer=null}catch(o){console.error("Failed to dispose audio emitter:",o)}}function Yt({color:e=16777215,intensity:o=1,mapSize:i=1024,far:r=15,bounds:n={left:-7,right:7,top:7,bottom:-7},position:t=[5,3,4]}={}){const s=new bt(e,o);return s.castShadow=!0,s.shadow.mapSize.set(i,i),s.shadow.camera.far=r,s.shadow.camera.left=n.left,s.shadow.camera.right=n.right,s.shadow.camera.top=n.top,s.shadow.camera.bottom=n.bottom,s.position.set(...t),s}function Zt(e=[]){return e.map(o=>Yt(o))}function fe(e){if(typeof e=="string"){if(e.startsWith("#")&&(e.length===7||e.length===9))return e.slice(0,7);try{const o=Number(e);if(!Number.isNaN(o))return`#${(o>>>0).toString(16).padStart(6,"0")}`}catch{}return e}return`#${(e>>>0).toString(16).padStart(6,"0")}`}function Jt(e,{size:o=.2,color:i=16776960,showCone:r=!1,coneAngle:n=N.innerAngle,coneDirection:t=new v(0,0,1)}={}){const s=new it;if(r){const c=o*3,d=le.degToRad(n),a=Math.tan(d)*c,f=new gt(a,c,16,1,!0),p=new Oe({color:i,wireframe:!0,transparent:!0,opacity:.6,side:ht}),u=new xe(f,p),g=new v(0,-1,0),h=new mt;h.setFromUnitVectors(g,t.clone().normalize()),u.quaternion.copy(h),u.position.copy(t.clone().normalize().multiplyScalar(c/2)),s.add(u);const b=new Ye(o*.3),C=new Oe({color:i,transparent:!0,opacity:.9}),x=new xe(b,C);s.add(x)}else{const c=new Ye(o),d=new Oe({color:i,wireframe:!0,transparent:!0,opacity:.8}),a=new xe(c,d);s.add(a)}return s.position.copy(e.position),s}function eo({color:e=16777182,intensity:o=3,distance:i=10,angle:r=Math.PI/6,penumbra:n=.5,decay:t=1,leftPosition:s=[.75,.76,1.8],rightPosition:c=[-.75,.76,1.8],targetPosition:d=[0,0,10]}={}){const a=new Ze(e,o,i,r,n,t);a.position.set(...s),a.target.position.set(...d),a.castShadow=!0,a.shadow.mapSize.width=1024,a.shadow.mapSize.height=1024,a.shadow.camera.near=.5,a.shadow.camera.far=20,a.shadow.camera.fov=30;const f=new Ze(e,o,i,r,n,t);return f.position.set(...c),f.target.position.set(...d),f.castShadow=!0,f.shadow.mapSize.width=1024,f.shadow.mapSize.height=1024,f.shadow.camera.near=.5,f.shadow.camera.far=20,f.shadow.camera.fov=30,{left:a,right:f}}function ye(e,o,i,{store:r=null,storeKey:n=null,loop:t=!1,refDistance:s=20,volume:c=null,offset:d=0,onEnded:a=null}={}){const f=p=>{try{o.stop(),o.setBuffer(p),o.setRefDistance(s),o.setLoop(t),typeof c=="number"&&o.setVolume&&o.setVolume(c),a&&(o.onEnded=a),o.play()}catch(u){console.error("Failed to play positional audio:",u)}};if(r&&n&&r[n]){f(r[n]);return}Se(e,i).then(p=>{r&&n&&(r[n]=p),f(p)}).catch(p=>{console.error("Failed to load and play audio:",i,p)})}function He({screenAnchor:e=new ve(-.9,.9),targetLocalPos:o=new v(0,0,0),targetObject:i=null,label:r="btn",color:n=65280}={}){const t=[new v,new v],s=new rt().setFromPoints(t),c=new yt({color:n}),d=new xt(s,c);d.set;let a=null;typeof document<"u"&&(a=document.createElement("button"),a.color=n,a.dimmed=!1,a.className="three-linebutton",a.style.position="absolute",a.style.padding="4px 12px",a.style.border="none",a.style.borderRadius="12px",a.style.backgroundColor=fe(n),a.style.color="#272727ff",a.style.fontFamily="sans-serif",a.style.fontSize="14px",a.style.cursor="pointer",a.style.transform="translate(-50%, -50%)",a.style.boxShadow="0 2px 2px rgba(255, 255, 255, 0.24)",a.style.userSelect="none",a.textContent=r,document.body.appendChild(a),a.addEventListener("mouseenter",()=>{a.style.backgroundColor=fe(Math.min(n*4,16777215))}),a.addEventListener("mouseleave",()=>{a.style.backgroundColor=a.dimmed?"#444444":fe(n)}));const f=new vt;let p=!0;const u=new v,g=new v,h=new v,b=new v,C=new v,x=new v,M=new v;let ne=null,G=null,me=0;function Re(A){if((me%30===0||!ne)&&(ne=document.querySelector("canvas.webgl"),ne&&(G=ne.getBoundingClientRect())),me++,u.set(e.x,e.y,.5),u.unproject(A),g.copy(u).sub(A.position).normalize(),h.copy(A.position).add(g.multiplyScalar(1)),i?(b.copy(o),i.localToWorld(b)):b.copy(o),C.copy(b).sub(A.position).normalize(),f.set(A.position,C),x.copy(b),i){const j=f.intersectObject(i,!0);j&&j.length>0&&x.copy(j[0].point)}const _=d.geometry.attributes.position;if(_.setXYZ(0,h.x,h.y,h.z),_.setXYZ(1,x.x,x.y,x.z),_.needsUpdate=!0,a&&G)if(M.copy(h).project(A),!p||M.z>1||M.z<-1||M.x<-1.2||M.x>1.2||M.y<-1.2||M.y>1.2)a.style.display="none";else{a.style.display="";const j=(M.x*.5+.5)*G.width+G.left,Te=(-M.y*.5+.5)*G.height+G.top;a.style.left=`${j}px`,a.style.top=`${Te}px`}}function k(A){p=A,d.visible=A,a&&(a.style.display=A?"":"none")}function B(){a&&a.parentElement&&(a.removeEventListener("mouseenter",null),a.removeEventListener("mouseleave",null),a.parentElement.removeChild(a),a=null),d.geometry&&d.geometry.dispose(),d.material&&d.material.dispose()}return{line:d,button:a,update:Re,setVisible:k,dispose:B}}const Fe=1e3,z=new rt,Ee=new Float32Array(Fe*3),ce=new Float32Array(Fe*4),lt=new Float32Array(Fe);z.setAttribute("position",new qe(Ee,3));z.setAttribute("color",new qe(ce,4));z.setAttribute("size",new qe(lt,1));const $e=new wt({size:.1,vertexColors:!0,transparent:!0,opacity:.5,blending:Et}),to=new Ct(z,$e),D={pool:[],active:[],acquire(){let e;return this.pool.length>0?e=this.pool.pop():e={offset:[0,0,0],scale:[0,0],quaternion:[0,0,0,0],rotation:0,color:[1,1,1,1],blend:0,texture:0,live:0,scaleIncrease:0,opacityDecrease:0,colorFrom:[0,0,0],colorTo:[0,0,0],colorSpeed:0,colorProgress:0},this.active.push(e),e},release(e){const o=this.active.indexOf(e);o>-1&&(this.active.splice(o,1),this.pool.push(e))},getActiveCount(){return this.active.length},clear(){for(;this.active.length>0;)this.pool.push(this.active.pop())}},y={emitters:[],enabled:!0,visible:!0,backfireActive:!1,backfireElapsed:0,backfireDuration:.5,initialize:()=>{const e={enabled:!1,position:new v(-.5,.3,-2),settings:{radius1:.02,radius2:.1,radiusHeight:.2,addTime:.02,elapsed:0,liveTimeFrom:1,liveTimeTo:1.5,opacityDecrease:.008,rotationFrom:.5,rotationTo:1,speedFrom:.003,speedTo:.006,scaleFrom:.1,scaleIncrease:.002,colorFrom:[.9,.9,.9],colorTo:[.5,.5,.5],colorSpeedFrom:1,colorSpeedTo:1,brightnessFrom:.5,brightnessTo:.9,opacity:.6,blend:.8,texture:.5},backfireSettings:{radius1:.02,radius2:.03,radiusHeight:.01,addTime:.005,elapsed:0,liveTimeFrom:.2,liveTimeTo:.4,opacityDecrease:.02,rotationFrom:2,rotationTo:4,speedFrom:.01,speedTo:.02,scaleFrom:.15,scaleIncrease:-.003,colorFrom:[1,.3,.1],colorTo:[.9,.6,0],colorSpeedFrom:2,colorSpeedTo:3,brightnessFrom:.8,brightnessTo:1,opacity:.8,blend:1,texture:.3}};y.emitters.push(e)},update:(e,o)=>{y.backfireActive&&(y.backfireElapsed+=e,y.backfireElapsed>=y.backfireDuration&&(y.backfireActive=!1,y.backfireElapsed=0)),y.emitters.forEach(n=>{const t=y.backfireActive?n.backfireSettings:n.settings;if(o!=="stop"||y.backfireActive?(n.enabled=!0,y.backfireActive||(t.addTime=o==="accel"?.01:.02,t.speedFrom=o==="accel"?.005:.003,t.speedTo=o==="accel"?.008:.006),t.elapsed+=e):n.enabled=!1,n.enabled){let s=0;for(s=Math.floor(t.elapsed/t.addTime),t.elapsed-=s*t.addTime;s--&&!(D.getActiveCount()>=Fe);){const c=D.acquire(),d=t.radius1*Math.sqrt(Math.random()),a=2*Math.PI*Math.random(),f=n.position.x+d*Math.cos(a),p=n.position.z+d*Math.sin(a),u=t.radius2*Math.sqrt(Math.random()),g=f+u*Math.cos(a),h=p+u*Math.sin(a),b=new v(g-f,t.radiusHeight,h-p).normalize(),C=Math.random()*(t.speedTo-t.speedFrom)+t.speedFrom;b.multiplyScalar(C);const x=Math.random()*(t.brightnessTo-t.brightnessFrom)+t.brightnessFrom;c.offset[0]=f,c.offset[1]=n.position.y,c.offset[2]=p,c.scale[0]=t.scaleFrom,c.scale[1]=t.scaleFrom,c.quaternion[0]=b.x,c.quaternion[1]=b.y,c.quaternion[2]=b.z,c.quaternion[3]=3,c.rotation=Math.random()*(t.rotationTo-t.rotationFrom)+t.rotationFrom,c.color[0]=1,c.color[1]=1,c.color[2]=1,c.color[3]=t.opacity,c.blend=t.blend,c.texture=t.texture,c.live=Math.random()*(t.liveTimeTo-t.liveTimeFrom)+t.liveTimeFrom,c.scaleIncrease=t.scaleIncrease,c.opacityDecrease=t.opacityDecrease,c.colorFrom[0]=t.colorFrom[0]*x,c.colorFrom[1]=t.colorFrom[1]*x,c.colorFrom[2]=t.colorFrom[2]*x,c.colorTo[0]=t.colorTo[0]*x,c.colorTo[1]=t.colorTo[1]*x,c.colorTo[2]=t.colorTo[2]*x,c.colorSpeed=Math.random()*(t.colorSpeedTo-t.colorSpeedFrom)+t.colorSpeedFrom,c.colorProgress=0}}});const i=D.active;for(let n=i.length-1;n>=0;n--){const t=i[n];if(t.offset[0]+=t.quaternion[0],t.offset[1]+=t.quaternion[1],t.offset[2]+=t.quaternion[2],t.scale[0]+=t.scaleIncrease,t.scale[1]+=t.scaleIncrease,t.colorProgress+=t.colorSpeed,t.colorProgress>1&&(t.colorProgress=1),t.color[0]=t.colorFrom[0]+(t.colorTo[0]-t.colorFrom[0])*t.colorProgress,t.color[1]=t.colorFrom[1]+(t.colorTo[1]-t.colorFrom[1])*t.colorProgress,t.color[2]=t.colorFrom[2]+(t.colorTo[2]-t.colorFrom[2])*t.colorProgress,t.color[3]-=t.opacityDecrease,t.live-=e,t.live<=0||t.color[3]<=0||t.scale[0]<=0){D.release(t);continue}}const r=D.getActiveCount();for(let n=0;n<r;n++){const t=i[n],s=n*3;Ee[s]=t.offset[0],Ee[s+1]=t.offset[1],Ee[s+2]=t.offset[2];const c=n*4;ce[c]=t.color[0],ce[c+1]=t.color[1],ce[c+2]=t.color[2],ce[c+3]=t.color[3],lt[n]=t.scale[0]}z.setDrawRange(0,r),r>0&&(z.attributes.position.needsUpdate=!0,z.attributes.color.needsUpdate=!0,z.attributes.size.needsUpdate=!0)},getMesh:()=>to,dispose:()=>{D.clear(),z&&z.dispose(),$e&&$e.dispose(),y.emitters.length=0},getStats:()=>({activeParticles:D.getActiveCount(),pooledParticles:D.pool.length,totalAllocated:D.active.length+D.pool.length}),triggerBackfire:(e=.5)=>{y.backfireActive=!0,y.backfireElapsed=0,y.backfireDuration=e,console.log(`ðŸ”¥ Backfire triggered (${e}s)`)}};function oo({emitters:e={},initialVisible:o=!1}={}){let i=o,r=null;const n=new Map;function t(){return r||(r=document.createElement("div"),r.id="audio-volume-panel",Object.assign(r.style,{position:"fixed",bottom:"10px",right:"10px",padding:"8px",background:"rgba(0,0,0,0.6)",color:"#fff",borderRadius:"6px",zIndex:9999,fontFamily:"monospace",fontSize:"12px",pointerEvents:"none",display:i?"":"none"}),document.body.appendChild(r),r)}function s(u){const g=document.createElement("div");g.dataset.pos=u,Object.assign(g.style,{display:"flex",alignItems:"center",marginBottom:"6px",pointerEvents:"auto",flexDirection:"row"});const h=document.createElement("div");h.className="vol-label",h.textContent=u,Object.assign(h.style,{width:"70px",textTransform:"capitalize"});const b=document.createElement("div");b.className="vol-bar-container",Object.assign(b.style,{width:"64px",height:"12px",background:"rgba(255,255,255,0.08)",borderRadius:"3px",display:"flex",alignItems:"center",overflow:"hidden",marginLeft:"8px",marginRight:"8px"});const C=document.createElement("div");C.className="vol-bar",Object.assign(C.style,{width:"0%",height:"100%",background:"#666",transition:"width 0.08s linear"});const x=u.toUpperCase();return K[x]!==void 0&&(C.style.background=fe(K[x])),b.appendChild(C),g.appendChild(h),g.appendChild(b),g}function c(u,g){if(!n.has(u)&&g?.getOutput()){const h=new Lt(g,32);n.set(u,h)}return n.get(u)}function d(u,g){const h=c(u,g);if(!h)return 0;const b=h.getAverageFrequency()/255,C=g&&g.getVolume?g.getVolume():0;return b*C}function a(){const u=t();Object.entries(e).forEach(([g,h])=>{if(g==="mix")return;let b=u.querySelector(`[data-pos="${g}"]`);b||(b=s(g),u.appendChild(b));const C=d(g,h)*3,x=b.querySelector(".vol-bar");x.style.width=`${Math.max(0,Math.min(1,C))*100}%`}),r.style.display=i?"":"none"}function f(u){i=!!u,r&&(r.style.display=i?"":"none")}function p(){n.forEach(u=>{if(u&&u.analyser)try{u.analyser.disconnect()}catch(g){console.warn("Error disposing analyser:",g)}}),n.clear(),r&&r.parentElement&&(r.parentElement.removeChild(r),r=null)}return{update:a,setVisible:f,isVisible:()=>i,dispose:p}}function no({initVisible:e=!1,initIgnition:o=!1,initHeadlights:i=!0}={}){let r=null,n=e,t=null,s=o,c=null,d=null,a=i,f=null,p=null,u=0,g=!1,h=null;function b(k){c=k}function C(k){f=k}function x(k){h=k}function M(){if(r)return r;r=document.createElement("div"),r.id="controls-panel",Object.assign(r.style,{position:"fixed",top:"10px",left:"10px",padding:"8px",background:"rgba(0,0,0,0.0)",color:"#fff",border:"none",zIndex:9999,fontFamily:"monospace",fontSize:"12px",pointerEvents:"auto",display:n?"":"none"}),t=document.createElement("button"),t.className="ignition-toggle",t.innerHTML=`
            <span class="ignition-start" style="font-weight:bold;color:#fff;">START</span>
            <span class="ignition-stop" style="color:#aaa;">STOP</span>
        `,Object.assign(t.style,{display:"block",margin:"4px auto 0 auto",padding:"0",width:"75px",height:"75px",borderRadius:"50%",background:"radial-gradient(circle at 60% 40%, #a00 80%, #cc2f2f 100%)",border:"2px solid #fff",boxShadow:"0 2px 8px rgba(0,0,0,0.4)",cursor:"pointer",color:"#fff",fontFamily:"inherit",fontSize:"16px",textAlign:"center",lineHeight:"16px",position:"relative",transition:"background 0.2s"});function k(){const O=t.querySelector(".ignition-start"),P=t.querySelector(".ignition-stop");s?(O.style.fontWeight="normal",O.style.color="#888",P.style.fontWeight="bold",P.style.color="#fff",t.style.background="radial-gradient(circle at 60% 40%, #cc2f2f 80%, #a00 100%)"):(O.style.fontWeight="bold",O.style.color="#fff",P.style.fontWeight="normal",P.style.color="#888",t.style.background="radial-gradient(circle at 60% 40%, #a00 80%, #cc2f2f 100%)"),c&&c(s)}r.appendChild(t),d=document.createElement("button"),d.className="headlights-toggle",d.innerHTML=`
            <span style="
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            position: absolute;
            left: 0; top: 0;
            ">
            <svg width="36" height="36" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
            <!-- Bulb -->
            <path d="M18 36 A6 6 0 0 1 18 12" fill="none" stroke="#fff" stroke-width="2.2"/>
            <line x1="18" y1="12" x2="18" y2="36" stroke="#fff" stroke-width="2.2"/>
            <!-- Beams, angled downwards -->
            <line class="beam beam-1" x1="26" y1="19" x2="40" y2="23" stroke="#ff0" stroke-width="3" stroke-linecap="round" opacity="1"/>
            <line class="beam beam-2" x1="26" y1="24" x2="40" y2="28" stroke="#ff0" stroke-width="3" stroke-linecap="round" opacity="1"/>
            <line class="beam beam-3" x1="26" y1="29" x2="40" y2="33" stroke="#ff0" stroke-width="3" stroke-linecap="round" opacity="1"/>
            </svg>
            </span>
        `,Object.assign(d.style,{display:"block",margin:"12px auto 0 auto",padding:"0",width:"56px",height:"28px",borderRadius:"10px",background:"radial-gradient(circle at 60% 40%, #181818 80%, #222 100%)",border:"2px solid #fff",boxShadow:"0 2px 8px rgba(0,0,0,0.4)",cursor:"pointer",color:"#fff",fontFamily:"inherit",fontSize:"14px",textAlign:"center",lineHeight:"14px",position:"relative",transition:"background 0.2s",overflow:"hidden"});let B=null,A=!1;function _(){return B||(B=[d.querySelector(".beam-1"),d.querySelector(".beam-2"),d.querySelector(".beam-3")]),B}function j(O,P){const U=_()[O];U.setAttribute("stroke",P?"#ff0":"#888"),U.style.opacity=P?"1":"0.5"}function Te(O,P){if(A)return;A=!0,_();const U=O?[0,1,2]:[2,1,0];let Me=0;function Qe(){j(U[Me],O),Me++,Me<U.length?setTimeout(Qe,70):(A=!1,P&&P())}Qe()}function Xe(O=!1){O?Te(a,()=>{d.style.background=a?"radial-gradient(circle at 60% 40%, #222 80%, #333 100%)":"radial-gradient(circle at 60% 40%, #181818 80%, #222 100%)",f&&f(a)}):(_().forEach((P,U)=>j(U,a)),d.style.background=a?"radial-gradient(circle at 60% 40%, #222 80%, #333 100%)":"radial-gradient(circle at 60% 40%, #181818 80%, #222 100%)",f&&f(a))}Xe(!1),r.appendChild(d),p=document.createElement("button"),p.className="throttle-pedal",p.innerHTML=`
            <span style="
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            position: absolute;
            left: 0; top: 0;
            ">
            <svg width="22" height="48" viewBox="0 0 22 48" xmlns="http://www.w3.org/2000/svg">
            <!-- Pedal body -->
            <rect x="4" y="6" width="14" height="36" rx="7" fill="#fff" stroke="#bbb" stroke-width="1.5"/>
            <!-- Pedal shadow -->
            <rect x="6" y="10" width="10" height="28" rx="5" fill="#222" opacity="0.3"/>
            <!-- Pedal grip lines -->
            <line x1="7" y1="13" x2="15" y2="13" stroke="#888" stroke-width="1.2"/>
            <line x1="7" y1="19" x2="15" y2="19" stroke="#888" stroke-width="1.2"/>
            <line x1="7" y1="25" x2="15" y2="25" stroke="#888" stroke-width="1.2"/>
            <line x1="7" y1="31" x2="15" y2="31" stroke="#888" stroke-width="1.2"/>
            <line x1="7" y1="37" x2="15" y2="37" stroke="#888" stroke-width="1.2"/>
            </svg>
            </span>
        `,Object.assign(p.style,{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",position:"absolute",left:"92px",top:"0",height:"60px",width:"24px",margin:"20px auto 0 auto",padding:"0",borderRadius:"12px",background:"linear-gradient(to bottom, #444 0%, #222 100%)",border:"2px solid #fff",boxShadow:"0 2px 8px rgba(0,0,0,0.4)",cursor:"pointer",color:"#fff",fontFamily:"inherit",fontSize:"12px",textAlign:"center",lineHeight:"14px",transition:"background 0.2s",visibility:s?"visible":"hidden"}),r.appendChild(p);function Ke(){p.style.visibility=s?"visible":"hidden"}return Ke(),t.addEventListener("click",()=>{s=!s,k(),Ke()}),d.addEventListener("click",()=>{a=!a,Xe(!0)}),p.addEventListener("mousedown",()=>{u=performance.now(),g=!0}),p.addEventListener("mouseup",()=>{p.style.background="linear-gradient(to bottom, #444 0%, #222 100%)",g=!1}),document.body.appendChild(r),r}function ne(){if(u>0){const k=performance.now()-u,B=Math.max(0,1-k/R.long);if(p.style.background=`linear-gradient(to bottom, rgba(20, 20, 20, ${B}) 100%, rgba(255, 255, 255, ${B}) 100%)`,k>=R.long)h&&h(R.long),u=0;else if(k>=R.medium&&!g)h&&h(R.medium),u=0;else if(k<R.short&&!g)h&&h(R.short),u=0;else return;p.style.background="linear-gradient(to bottom, #444 0%, #222 100%)"}}function G(){M(),ne(),r.style.display=n?"":"none"}function me(k){n=!!k,r&&(r.style.display=n?"":"none")}function Re(){r&&r.parentElement&&(r.parentElement.removeChild(r),r=null)}return{registerIgnitionCallback:b,registerHeadlightsCallback:C,registerThrottleCallback:x,update:G,setVisible:me,isVisible:()=>n,dispose:Re}}function io({initialVisible:e=!1}={}){let o=e,i=null,r=0,n=performance.now(),t=0,s=0;function c(){return i||(i=document.createElement("div"),i.id="performance-stats",Object.assign(i.style,{position:"fixed",bottom:"10px",left:"10px",padding:"8px",background:"rgba(0,0,0,0.6)",color:"#fff",borderRadius:"6px",zIndex:9999,fontFamily:"monospace",fontSize:"12px",pointerEvents:"none",display:o?"":"none",minWidth:"120px"}),document.body.appendChild(i),i)}function d(){r++;const p=performance.now(),u=p-n;if(u>=1e3&&(t=Math.round(r*1e3/u),s=u/r,r=0,n=p),o){const g=c();let h="#00ff00";t<60&&(h="#ffff00"),t<30&&(h="#ff0000"),g.innerHTML=`
                <div style="margin-bottom: 4px;">
                    <span style="color: #888;">FPS:</span> 
                    <span style="color: ${h}; font-weight: bold;">${t}</span>
                </div>
                <div>
                    <span style="color: #888;">Frame:</span> 
                    <span>${s.toFixed(2)}ms</span>
                </div>
            `}}function a(p){o=!!p,i&&(i.style.display=o?"":"none")}function f(){i&&i.parentElement&&(i.parentElement.removeChild(i),i=null)}return{update:d,setVisible:a,isVisible:()=>o,dispose:f,getStats:()=>({fps:t,frameTime:s})}}kt.enabled=!1;var re=X.STOP,Ce=ue.MIX;const De=_t();if(!De.available)throw te("WebGL Not Supported",De.error,!0),new Error(De.error);const ze=Ut();if(!ze.available)throw te("Web Audio Not Supported",ze.error,!0),new Error(ze.error);const Q={modelsLoaded:!1,audioLoaded:!1,sceneReady:!1},ct=document.querySelector("canvas.webgl"),m=new St;m.background=new st(10526880);m.fog=new Ft(15716789,.05);const he=new At,pe={Meters:!0,Emitters:!1},Ae=he.addFolder("Audio");let de=null;const dt=he.addFolder("Vehicle"),ro=he.addFolder("Performance"),so={"Show Stats":!1},We=new Rt,ie=new _e,ao=new Tt;new Mt;const oe=new xe(new Ot(10,10),new Pt({color:"#444444",metalness:0,roughness:.5}));oe.receiveShadow=!0;oe.rotation.x=-Math.PI*.5;m.add(oe);const Ve=m.background?m.background.clone():new st(10526880);let $=null;const lo=["None",...Object.keys(at)],co={HDR:"None"};dt.add(co,"HDR",lo).name("Level Select").onChange(e=>{if(e==="None"){$&&(Ne($),$=null),m.background=Ve.clone?Ve.clone():Ve,m.environment=null,oe.visible=!0,tt(null),m.fog&&(m.fog.color.set(15716789),m.fog.density=.05),typeof E.toneMappingExposure=="number"&&(E.toneMappingExposure=F.exposure),m.traverse(n=>{n.isMesh&&n.material&&(Array.isArray(n.material)?n.material.forEach(t=>t.needsUpdate=!0):n.material.needsUpdate=!0)}),console.log("[HDR Reset] Ambient",H.intensity,H.color.getHexString()),ae.forEach((n,t)=>console.log(`[HDR Reset] Dir${t}`,n.intensity,n.color.getHexString())),console.log("[HDR Reset] Hemi",S.intensity,S.color.getHexString(),S.groundColor.getHexString()),w.removeConvolutionReverb(),Le.Reverb="None",de&&de.updateDisplay();return}const o=at[e];if(!o)return;const i=typeof o=="string"?o:o.path,r=typeof o=="object"?o.reverb:null;Kt(ao,i).then(n=>{if($&&Ne($),n.mapping=zt,$=n,m.background=n,m.environment=n,oe.visible=!1,o.lighting&&tt(o.lighting),r&&Le&&(Le.Reverb=r,de)){de.updateDisplay();const t=Be[r];if(t){const{path:s,blend:c=.5,scalingFactor:d=1}=t;w.currentReverbBlend=c,w.currentReverbScalingFactor=d,Se(new _e,s).then(a=>{w.applyConvolutionReverb(a)}).catch(a=>{console.error("Failed to load reverb:",a),te("Reverb Load Failed",`Could not load reverb: ${a.message}`,!1)})}}}).catch(n=>{console.error("Failed to load HDR:",n),te("HDR Load Failed",`Could not load environment: ${n.message}`,!1)})});let L=new it;m.add(L);L.add(y.getMesh());const Z=[];let l={mixerWheels:null,actWheelsRot:null,actTiresRot:null,mixerLights:null,actLights0:null,actLights1:null,actLights2:null,actLights3:null,actLights4:null,headLightL:null,headLightR:null,lightsFlipFlop:!0,lightsIntensity:3,lightsTimeScaleToggle:()=>{if(l.mixerLights)if(l.lightsFlipFlop){l.mixerLights.timeScale=1.5;for(let e=0;e<5;e++){const o=`actLights${e}`;l[o]&&(l[o].time=0)}l.lightsFlipFlop=!1}else{l.mixerLights.timeScale=-1.5;for(let e=0;e<5;e++){const o=`actLights${e}`;l[o]&&(l[o].time=l[o].getClip().duration-l[o].time)}l.lightsFlipFlop=!0}},lights:()=>{l.mixerLights&&(l.mixerLights.stopAllAction(),l.lightsTimeScaleToggle(),l.actLights0&&l.actLights0.play(),l.actLights1&&l.actLights1.play(),l.actLights2&&l.actLights2.play(),l.actLights3&&l.actLights3.play(),l.actLights4&&l.actLights4.play())}};async function uo(){const e=Xt("Loading models...");try{e.update("Loading car model...");const[o,i,r]=await Promise.all([Ie(We,"./model/rx7/rx7.gltf"),Ie(We,"./model/rx7_wheels/rx7_wheels.gltf"),Ie(We,"./model/rx7_lights/rx7_lights.gltf")]);e.update("Setting up scene..."),o.scene.scale.set(1,1,1),L.add(o.scene),y.initialize(),i.scene.scale.set(1,1,1),i.scene.position.set(0,0,0),L.add(i.scene);const n=i.scene.clone();n.position.set(0,0,2.45),L.add(n);const t=i.scene.clone();t.position.set(0,0,2.45),t.scale.set(-1,1,1),L.add(t);const s=i.scene.clone();s.position.set(0,0,0),s.scale.set(-1,1,1),L.add(s),l.mixerWheels=new Je(new Bt(i.scene,n,t,s)),l.actWheelsRot=l.mixerWheels.clipAction(i.animations[0]),l.actTiresRot=l.mixerWheels.clipAction(i.animations[1]),r.scene.scale.set(1,1,1),L.add(r.scene),l.mixerLights=new Je(r.scene);for(let a=0;a<5;a++){const f=`actLights${a}`;l[f]=l.mixerLights.clipAction(r.animations[a]),l[f].setLoop(jt),l[f].clampWhenFinished=!0}const{left:c,right:d}=eo({intensity:l.lightsIntensity});l.headLightL=c,l.headLightR=d,L.add(l.headLightL),L.add(l.headLightL.target),L.add(l.headLightR),L.add(l.headLightR.target),fo(o.scene),Q.modelsLoaded=!0,e.remove(),console.log("âœ“ All models loaded successfully")}catch(o){e.remove(),console.error("Failed to load models:",o),te("Failed to Load Models",`Could not load required 3D models. Please check your connection and refresh the page.

Error: ${o.message}`,!1)}}function fo(e){const o=He({screenAnchor:new ve(-.5,-.8),targetLocalPos:new v(0,.2,2.1),targetObject:e,label:"Intake",color:K.INTAKE}),i=He({screenAnchor:new ve(.5,-.8),targetLocalPos:new v(-.5,.3,-2),targetObject:e,label:"Exhaust",color:K.EXHAUST}),r=He({screenAnchor:new ve(0,-.8),targetLocalPos:new v(0,.1,-.2),targetObject:e,label:"Interior",color:K.INTERIOR});[o,i,r].forEach(t=>{m.add(t.line),Z.push(t),t.button.addEventListener("click",()=>{ue[t.button.textContent.toUpperCase()]===Ce?(Ce=ue.MIX,Z.forEach(s=>{s!==t&&(s.button.style.backgroundColor=fe(K[s.button.textContent.toUpperCase()]),s.button.style.color="#272727ff",s.line.visible=!0,s.button.dimmed=!1)}),pe.Emitters&&ee.forEach(s=>s.visible=!0)):(Ce=ue[t.button.textContent.toUpperCase()],Z.forEach(s=>{if(s!==t){if(s.button.style.backgroundColor="#444444",s.button.style.color="#888888",s.line.visible=!1,s.button.dimmed=!0,pe.Emitters){const c=s.button.textContent.toLowerCase(),d=ee.get(c);d&&(d.visible=!1)}}else if(s.button.style.color="#272727ff",s.line.visible=!0,s.button.dimmed=!1,pe.Emitters){const c=s.button.textContent.toLowerCase(),d=ee.get(c);d&&(d.visible=!0)}}))})});const n={"Solo Buttons":!0};Ae.add(n,"Solo Buttons").onChange(t=>{o.setVisible(t),i.setVisible(t),r.setVisible(t)})}uo().then(()=>{Ge()}).catch(e=>{console.error("Critical error during model initialization:",e)});function Ge(){Q.modelsLoaded&&Q.audioLoaded&&!Q.sceneReady&&(Q.sceneReady=!0,console.log("âœ“ Scene fully initialized and ready"))}const S=new Dt(I.hemisphere.skyColor,I.hemisphere.groundColor,I.hemisphere.intensity);S.position.set(0,100,0);m.add(S);const H=new Ht(I.ambient.color,I.ambient.intensity);m.add(H);const ae=Zt([{color:I.directional[0].color,intensity:I.directional[0].intensity,position:[5,3,4]},{color:I.directional[1].color,intensity:I.directional[1].intensity,position:[8,3,-1]},{color:I.directional[2].color,intensity:I.directional[2].intensity,position:[-5,5,-5]}]);ae.forEach(e=>m.add(e));let F=null;function ut(){F={ambient:{color:H.color.getHex(),intensity:H.intensity},hemi:{sky:S.color.getHex(),ground:S.groundColor.getHex(),intensity:S.intensity},directional:ae.map(e=>({color:e.color.getHex(),intensity:e.intensity})),fog:m.fog?{color:m.fog.color.getHex(),density:m.fog.density}:null,exposure:typeof E<"u"&&typeof E.toneMappingExposure=="number"?E.toneMappingExposure:1}}function ft(){F||ut(),H.color.setHex(F.ambient.color),H.intensity=F.ambient.intensity,S.color.setHex(F.hemi.sky),S.groundColor.setHex(F.hemi.ground),S.intensity=F.hemi.intensity,ae.forEach((e,o)=>{e.color.setHex(F.directional[o].color),e.intensity=F.directional[o].intensity}),m.fog&&F.fog&&(m.fog.color.setHex(F.fog.color),m.fog.density=F.fog.density),F&&typeof E<"u"&&typeof E.toneMappingExposure=="number"&&(E.toneMappingExposure=F.exposure)}function tt(e){if(!e){ft();return}e.ambient&&(e.ambient.color!==void 0&&H.color.setHex(e.ambient.color),e.ambient.intensity!==void 0&&(H.intensity=e.ambient.intensity)),e.hemisphere&&(e.hemisphere.skyColor!==void 0&&S.color.setHex(e.hemisphere.skyColor),e.hemisphere.groundColor!==void 0&&S.groundColor.setHex(e.hemisphere.groundColor),e.hemisphere.intensity!==void 0&&(S.intensity=e.hemisphere.intensity)),e.directional&&Array.isArray(e.directional)&&ae.forEach((o,i)=>{const r=e.directional[i];r&&(r.color!==void 0&&o.color.setHex(r.color),r.intensity!==void 0&&(o.intensity=r.intensity))})}const W={width:window.innerWidth,height:window.innerHeight},po=()=>{W.width=window.innerWidth,W.height=window.innerHeight,q.aspect=W.width/W.height,q.updateProjectionMatrix(),E.setSize(W.width,W.height),E.setPixelRatio(Math.min(window.devicePixelRatio,2))};window.addEventListener("resize",po);const q=new Wt(75,W.width/W.height,.1,100);q.position.set(4,2,3);m.add(q);const Ue=new Vt(q,ct);Ue.target.set(0,.75,0);Ue.enableDamping=!0;const E=new It({canvas:ct});E.outputColorSpace=Nt;E.shadowMap.enabled=!0;E.shadowMap.type=$t;E.setSize(W.width,W.height);E.setPixelRatio(Math.min(window.devicePixelRatio,2));ut();ft();const Y=new Gt;q.add(Y);const se=Y.context,T={mix:new be(Y),intake:new be(Y),exhaust:new be(Y),interior:new be(Y)};console.log("Audio Emitters:",T);Object.entries(T).forEach(([e,o])=>{switch(L.add(o),e){case"intake":o.position.set(0,.2,2.1),o.setVolume(0),o.setDirectionalCone(le.degToRad(N.innerAngle),le.degToRad(N.outerAngle),N.outerGain);break;case"exhaust":o.position.set(-.5,.3,-2),o.setVolume(0),o.rotation.y=Math.PI,o.setDirectionalCone(le.degToRad(N.innerAngle),le.degToRad(N.outerAngle),N.outerGain);break;case"interior":o.position.set(0,.5,-.2),o.setVolume(0);break;case"mix":o.position.set(0,0,0),o.setVolume(1);break;default:o.position.set(0,0,0);break}});const w={buffers:{mix:{},intake:{ignitionOn:null,idle:null,ignitionOff:null,revShort:null,revMedium:null,revLong:null},exhaust:{ignitionOn:null,idle:null,ignitionOff:null,revShort:null,revMedium:null,revLong:null},interior:{ignitionOn:null,idle:null,ignitionOff:null,revShort:null,revMedium:null,revLong:null}},currentEmitter:null,setEmitterVolumes(e){["intake","exhaust","interior"].forEach(i=>{const r=T[i];if(!r)return;const n=e===ue.MIX?Pe.MIX:i===e?1:0,t=Pe[i.toUpperCase()]!==void 0?Pe[i.toUpperCase()]:1,s=Math.max(0,Math.min(1,n*t)),c=r.getVolume();c<s?r.setVolume(Math.min(s,c+.2)):c>s&&r.setVolume(Math.max(s,c-.2))}),T.mix.setVolume(0)},idle:(e,o,i)=>{ye(e,o,`./audio/${i}/idle.ogg`,{store:w.buffers[i],storeKey:"idle",loop:!0,onEnded:()=>{}})},ignitionOn:()=>{se.state==="suspended"&&se.resume().then(()=>{console.log("Audio context enabled via user interaction")}).catch(e=>{console.error("Failed to resume audio context:",e)}),Object.entries(T).forEach(([e,o])=>{e!=="mix"&&ye(ie,o,`./audio/${e}/ignitionOn.ogg`,{store:w.buffers[e],storeKey:"ignitionOn",loop:!1,onEnded:()=>{w.idle(ie,o,e)}})}),re=X.ACCEL,l.mixerWheels&&(l.mixerWheels.stopAllAction(),l.actWheelsRot.play(),l.actTiresRot.play(),l.mixerWheels.timeScale=.01)},ignitionOff:()=>{Object.entries(T).forEach(([e,o])=>{e!=="mix"&&ye(ie,o,`./audio/${e}/ignitionOff.ogg`,{store:w.buffers[e],storeKey:"ignitionOff",loop:!1,onEnded:()=>{o.stop()}})}),re=X.DECEL},revEngine(e){const o=e>=R.long?"revLong":e>=R.medium?"revMedium":"revShort";Object.entries(T).forEach(([i,r])=>{i!=="mix"&&ye(ie,r,`./audio/${i}/${o}.ogg`,{store:w.buffers[i],storeKey:o,loop:!1,onEnded:()=>{w.idle(ie,r,i)}})}),e>=R.long&&y.triggerBackfire()},load(){const e=this,o=[];Object.keys(e.buffers).forEach(i=>{Object.keys(e.buffers[i]).forEach(r=>{const n=Se(ie,`./audio/${i}/${r}.ogg`).then(t=>{e.buffers[i][r]=t}).catch(t=>{console.error(`Failed to load audio ${i}/${r}:`,t)});o.push(n)})}),Promise.all(o).then(()=>{Q.audioLoaded=!0,console.log("âœ“ All audio files loaded"),Ge()}).catch(()=>{Q.audioLoaded=!0,te("Audio Load Warning","Some audio files failed to load. The experience may be incomplete.",!1),Ge()})},applyConvolutionReverb(e){const o=this.currentReverbBlend??.5;Object.values(T).forEach(i=>{if(i._reverbNodes){try{const{dryGain:d,wetGain:a,convolver:f}=i._reverbNodes;d.disconnect(),a.disconnect(),f.disconnect()}catch{}i._reverbNodes=null}const r=Y.context,n=r.createConvolver();n.buffer=e;const t=r.createGain(),s=r.createGain();t.gain.value=o*this.currentReverbScalingFactor,s.gain.value=(1-o)*this.currentReverbScalingFactor;const c=i.panner;if(!c){console.warn("PositionalAudio panner node missing; cannot apply reverb graph");return}c.connect(s),s.connect(r.destination),c.connect(n),n.connect(t),t.connect(r.destination),i._reverbNodes={convolver:n,wetGain:t,dryGain:s}})},removeConvolutionReverb(){Object.values(T).forEach(e=>{if(e._reverbNodes){try{const{dryGain:o,wetGain:i,convolver:r}=e._reverbNodes;o.disconnect(),i.disconnect(),r.disconnect()}catch(o){console.warn("Error disconnecting reverb nodes:",o)}e._reverbNodes=null}}),this.currentReverbBlend=null,this.currentReverbScalingFactor=null}};w.load();const Be={Garage:{path:"./audio/ir/garage.ogg",blend:.8,scalingFactor:.33},Outdoors:{path:"./audio/ir/outdoors.ogg",blend:.6,scalingFactor:.2}},Le={Reverb:"None"};de=Ae.add(Le,"Reverb",["None",...Object.keys(Be)]).name("Conv. Reverb").onChange(e=>{if(e==="None"){w.removeConvolutionReverb();return}const o=Be[e];if(!o)return;const{path:i,blend:r=.5,scalingFactor:n=1}=o;w.currentReverbBlend=r,w.currentReverbScalingFactor=n,Se(new _e,i).then(t=>{w.applyConvolutionReverb(t)}).catch(t=>{console.error("Failed to load reverb:",t),te("Reverb Load Failed",`Could not load reverb preset: ${t.message}`,!1)})});const V=no({initVisible:!0,initIgnition:!1,initHeadlights:!0});V.registerIgnitionCallback(e=>{console.log("Ignition:",e?"ON":"OFF"),e?w.ignitionOn():w.ignitionOff()});V.registerHeadlightsCallback(e=>{console.log("Headlights:",e?"ON":"OFF"),l.lights()});V.registerThrottleCallback(e=>{console.log("Throttle pressed:",e,"ms",e>=R.long?"(Long)":e>=R.medium?"(Medium)":"(Short)"),w.revEngine(e)});console.log("Controls panel created",V);const J=oo({emitters:T,initialVisible:!0});Ae.add(pe,"Meters").onChange(e=>J.setVisible(e));const ge=io({initialVisible:!1});ro.add(so,"Show Stats").onChange(e=>ge.setVisible(e));const ee=new Map;Object.entries(T).forEach(([e,o])=>{if(e==="mix")return;const i={color:K[e.toUpperCase()]||16776960,size:.4};e==="intake"?(i.showCone=!0,i.coneAngle=N.innerAngle,i.coneDirection=new v(0,0,1)):e==="exhaust"&&(i.showCone=!0,i.coneAngle=N.innerAngle,i.coneDirection=new v(0,0,-1));const r=Jt(o,i);r.visible=!1,L.add(r),ee.set(e,r)});Ae.add(pe,"Emitters").onChange(e=>{ee.forEach(o=>o.visible=e)});const ot=["Mazda RX-7 FD"];dt.add({car:ot[0]},"car",ot).name("Car").onChange(e=>{});function go(){console.log("Cleaning up resources..."),ke&&(cancelAnimationFrame(ke),ke=null),Z.forEach(e=>{e&&e.dispose&&e.dispose()}),Z.length=0,ee.forEach(e=>{we(e)}),ee.clear(),V&&V.dispose&&V.dispose(),J&&J.dispose&&J.dispose(),ge&&ge.dispose&&ge.dispose(),Object.values(T).forEach(e=>{Qt(e)}),y&&y.dispose&&y.dispose(),$&&(Ne($),$=null),L&&we(L),oe&&we(oe),l.mixerWheels&&(l.mixerWheels.stopAllAction(),l.mixerWheels=null),l.mixerLights&&(l.mixerLights.stopAllAction(),l.mixerLights=null),S&&m.remove(S),H&&m.remove(H),ae.forEach(e=>{m.remove(e),e.dispose()}),E&&E.dispose(),he&&he.destroy(),console.log("Cleanup complete")}let ke=null,je=!document.hidden;document.addEventListener("visibilitychange",()=>{je=!document.hidden,je?(console.log("Tab visible - resuming simulation"),se&&se.state==="suspended"&&se.resume().catch(e=>{console.warn("Failed to resume audio context:",e)})):(console.log("Tab hidden - pausing heavy computations"),se.suspend())});window.addEventListener("beforeunload",()=>{go()});const ho=new qt;let nt=0;const pt=()=>{const e=ho.getElapsedTime(),o=e-nt;if(nt=e,je){if(l.mixerWheels)switch(l.mixerWheels.update(o),re){case X.ACCEL:for(;l.mixerWheels.timeScale<1;)l.mixerWheels.timeScale+=o,l.mixerWheels.timeScale>=1&&(l.mixerWheels.timeScale=1,re=X.DRIVE);break;case X.DECEL:for(;l.mixerWheels.timeScale>0;)l.mixerWheels.timeScale-=o,l.mixerWheels.timeScale<=0&&(l.mixerWheels.timeScale=0,re=X.STOP,l.mixerWheels.stopAllAction());break}if(l.mixerLights&&(l.mixerLights.update(o),l.actLights0&&l.headLightL&&l.headLightR)){const i=l.lightsIntensity-l.actLights0.time/l.actLights0.getClip().duration*l.lightsIntensity;l.headLightL.intensity=l.headLightR.intensity=i}L.position.z=Math.sin(e*2)*.0125,y.update(o,re),Z.length>0&&Z.forEach(i=>{try{i.update(q)}catch{}}),w.setEmitterVolumes(Ce),V&&V.update&&V.update(),J&&J.update&&J.update()}Ue.update(),ge.update(),E.render(m,q),ke=window.requestAnimationFrame(pt)};pt();
//# sourceMappingURL=index-DnfQqgHi.js.map
