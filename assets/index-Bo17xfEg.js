import{G as Xe,C as at,M as Ce,D as lt,a as fe,V as b,Q as ct,S as $e,b as dt,c as Ge,d as Z,B as Ke,L as ut,e as ft,R as gt,f as ge,g as We,P as pt,A as ht,h as mt,i as yt,j as bt,k as xt,l as Qe,F as vt,m as wt,n as Et,o as ze,p as Ct,H as Lt,q as St,r as Ft,W as At,s as Rt,t as Mt,E as Tt,u as Ot,O as kt,v as Pt,w as It,x as Ht,y as de,z as _e,I as Dt,J as Wt,K as zt}from"./vendor-D4_FRbEO.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&o(r)}).observe(document,{childList:!0,subtree:!0});function s(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(n){if(n.ep)return;n.ep=!0;const i=s(n);fetch(n.href,i)}})();const z={STOP:"stop",DRIVE:"drive",ACCEL:"accel",DECEL:"decel"},ne={MIX:"mix",INTAKE:"intake",EXHAUST:"exhaust",INTERIOR:"interior"},V={MIX:10507946,INTAKE:5152511,EXHAUST:10289023,INTERIOR:16771220},Le={MIX:.8,INTAKE:.5,EXHAUST:.8,INTERIOR:.3},P={innerAngle:45,outerAngle:120,outerGain:.3},F={ambient:{color:16777215,intensity:.5},hemisphere:{skyColor:16777215,groundColor:9276813,intensity:.4},directional:[{color:16711661,intensity:1},{color:16775154,intensity:1},{color:16318207,intensity:.2}]},Ye={Garage:{path:"./hdri/garage.hdr",reverb:"Garage",lighting:{ambient:{color:15790320,intensity:.2},hemisphere:{skyColor:12632256,groundColor:3815994,intensity:.15},directional:[{color:12375295,intensity:1.5},{color:16768426,intensity:.5},{color:8947848,intensity:.1}]}},Track:{path:"./hdri/track.hdr",reverb:"Outdoors",lighting:{ambient:{color:16774803,intensity:.25},hemisphere:{skyColor:13428479,groundColor:5921370,intensity:.15},directional:[{color:16777215,intensity:.1},{color:16773841,intensity:.1},{color:11193599,intensity:0}]}}};function Vt(){try{const e=document.createElement("canvas"),t=e.getContext("webgl")||e.getContext("experimental-webgl");if(!t)return{available:!1,error:"WebGL is not supported by your browser or graphics driver."};const s=["OES_element_index_uint"];for(const o of s)if(!t.getExtension(o))return{available:!1,error:`WebGL extension ${o} is not supported.`};return{available:!0,error:null}}catch(e){return{available:!1,error:`WebGL check failed: ${e.message}`}}}function Nt(){try{return window.AudioContext||window.webkitAudioContext?{available:!0,error:null}:{available:!1,error:"Web Audio API is not supported by your browser."}}catch(e){return{available:!1,error:`Web Audio API check failed: ${e.message}`}}}function U(e,t,s=!0){const o=document.getElementById("error-overlay");o&&o.remove();const n=document.createElement("div");n.id="error-overlay",Object.assign(n.style,{position:"fixed",top:"0",left:"0",width:"100%",height:"100%",backgroundColor:s?"rgba(0, 0, 0, 0.95)":"rgba(0, 0, 0, 0.7)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:"99999",fontFamily:"system-ui, -apple-system, sans-serif",color:"#fff",padding:"20px",boxSizing:"border-box"});const i=document.createElement("div");Object.assign(i.style,{maxWidth:"500px",backgroundColor:"#1a1a1a",borderRadius:"12px",padding:"32px",boxShadow:"0 8px 32px rgba(0, 0, 0, 0.5)",border:"1px solid #333"});const r=document.createElement("h2");r.textContent=e,Object.assign(r.style,{margin:"0 0 16px 0",fontSize:"24px",fontWeight:"600",color:"#ff6b6b"});const d=document.createElement("p");if(d.textContent=t,Object.assign(d.style,{margin:"0 0 24px 0",fontSize:"16px",lineHeight:"1.6",color:"#ccc"}),i.appendChild(r),i.appendChild(d),!s){const c=document.createElement("button");c.textContent="Dismiss",Object.assign(c.style,{backgroundColor:"#444",color:"#fff",border:"none",borderRadius:"6px",padding:"12px 24px",fontSize:"14px",cursor:"pointer",fontWeight:"500"}),c.addEventListener("click",()=>n.remove()),c.addEventListener("mouseenter",()=>c.style.backgroundColor="#555"),c.addEventListener("mouseleave",()=>c.style.backgroundColor="#444"),i.appendChild(c)}n.appendChild(i),document.body.appendChild(n)}function $t(e="Loading..."){const t=document.getElementById("loading-overlay");t&&t.remove();const s=document.createElement("div");s.id="loading-overlay",Object.assign(s.style,{position:"fixed",top:"0",left:"0",width:"100%",height:"100%",backgroundColor:"rgba(0, 0, 0, 0.9)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:"99998",fontFamily:"system-ui, -apple-system, sans-serif",color:"#fff"});const o=document.createElement("div");Object.assign(o.style,{textAlign:"center"});const n=document.createElement("div");Object.assign(n.style,{width:"50px",height:"50px",margin:"0 auto 20px",border:"4px solid #333",borderTop:"4px solid #fff",borderRadius:"50%",animation:"spin 1s linear infinite"});const i=document.createElement("div");if(i.textContent=e,Object.assign(i.style,{fontSize:"16px",color:"#ccc"}),!document.getElementById("spinner-style")){const r=document.createElement("style");r.id="spinner-style",r.textContent=`
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `,document.head.appendChild(r)}return o.appendChild(n),o.appendChild(i),s.appendChild(o),document.body.appendChild(s),{update:r=>{i.textContent=r},remove:()=>{s.remove()}}}function Se(e,t,s=null){return new Promise((o,n)=>{e.load(t,i=>{console.log(`✓ Loaded model: ${t}`),o(i)},s,i=>{console.error(`✗ Failed to load model: ${t}`,i),n(new Error(`Failed to load model ${t}: ${i.message}`))})})}function xe(e,t){return new Promise((s,o)=>{e.load(t,n=>{console.log(`✓ Loaded audio: ${t}`),s(n)},null,n=>{console.error(`✗ Failed to load audio: ${t}`,n),o(new Error(`Failed to load audio ${t}: ${n.message}`))})})}function Gt(e,t){return new Promise((s,o)=>{e.load(t,n=>{console.log(`✓ Loaded HDR: ${t}`),s(n)},null,n=>{console.error(`✗ Failed to load HDR: ${t}`,n),o(new Error(`Failed to load HDR ${t}: ${n.message}`))})})}function pe(e){if(e){if(e.children)for(let t=e.children.length-1;t>=0;t--)pe(e.children[t]);e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(t=>qe(t)):qe(e.material)),e.renderTarget&&e.renderTarget.dispose(),e.parent&&e.parent.remove(e)}}function qe(e){e&&(Object.keys(e).forEach(t=>{const s=e[t];s&&typeof s=="object"&&"minFilter"in s&&s.dispose()}),e.dispose())}function ke(e){if(e)try{e.dispose()}catch(t){console.error("Failed to dispose texture:",t)}}function _t(e){if(e)try{if(e.isPlaying&&e.stop(),e._reverbNodes){const{dryGain:t,wetGain:s,convolver:o}=e._reverbNodes;try{t.disconnect(),s.disconnect(),o.disconnect()}catch(n){console.warn("Error disconnecting reverb nodes:",n)}e._reverbNodes=null}e.disconnect(),e.buffer=null}catch(t){console.error("Failed to dispose audio emitter:",t)}}function qt({color:e=16777215,intensity:t=1,mapSize:s=1024,far:o=15,bounds:n={left:-7,right:7,top:7,bottom:-7},position:i=[5,3,4]}={}){const r=new dt(e,t);return r.castShadow=!0,r.shadow.mapSize.set(s,s),r.shadow.camera.far=o,r.shadow.camera.left=n.left,r.shadow.camera.right=n.right,r.shadow.camera.top=n.top,r.shadow.camera.bottom=n.bottom,r.position.set(...i),r}function Ut(e=[]){return e.map(t=>qt(t))}function ie(e){if(typeof e=="string"){if(e.startsWith("#")&&(e.length===7||e.length===9))return e.slice(0,7);try{const t=Number(e);if(!Number.isNaN(t))return`#${(t>>>0).toString(16).padStart(6,"0")}`}catch{}return e}return`#${(e>>>0).toString(16).padStart(6,"0")}`}function jt(e,{size:t=.2,color:s=16776960,showCone:o=!1,coneAngle:n=P.innerAngle,coneDirection:i=new b(0,0,1)}={}){const r=new Xe;if(o){const d=t*3,c=Z.degToRad(n),l=Math.tan(c)*d,g=new at(l,d,16,1,!0),y=new Ce({color:s,wireframe:!0,transparent:!0,opacity:.6,side:lt}),u=new fe(g,y),f=new b(0,-1,0),h=new ct;h.setFromUnitVectors(f,i.clone().normalize()),u.quaternion.copy(h),u.position.copy(i.clone().normalize().multiplyScalar(d/2)),r.add(u);const m=new $e(t*.3),L=new Ce({color:s,transparent:!0,opacity:.9}),S=new fe(m,L);r.add(S)}else{const d=new $e(t),c=new Ce({color:s,wireframe:!0,transparent:!0,opacity:.8}),l=new fe(d,c);r.add(l)}return r.position.copy(e.position),r}function Bt({color:e=16777182,intensity:t=3,distance:s=10,angle:o=Math.PI/6,penumbra:n=.5,decay:i=1,leftPosition:r=[.75,.76,1.8],rightPosition:d=[-.75,.76,1.8],targetPosition:c=[0,0,10]}={}){const l=new Ge(e,t,s,o,n,i);l.position.set(...r),l.target.position.set(...c),l.castShadow=!0,l.shadow.mapSize.width=1024,l.shadow.mapSize.height=1024,l.shadow.camera.near=.5,l.shadow.camera.far=20,l.shadow.camera.fov=30;const g=new Ge(e,t,s,o,n,i);return g.position.set(...d),g.target.position.set(...c),g.castShadow=!0,g.shadow.mapSize.width=1024,g.shadow.mapSize.height=1024,g.shadow.camera.near=.5,g.shadow.camera.far=20,g.shadow.camera.fov=30,{left:l,right:g}}function Fe(e,t,s,{store:o=null,storeKey:n=null,loop:i=!1,refDistance:r=20,volume:d=null,offset:c=0,onEnded:l=null}={}){const g=y=>{try{t.stop(),t.setBuffer(y),t.setRefDistance(r),t.setLoop(i),typeof d=="number"&&t.setVolume&&t.setVolume(d),l&&(t.onEnded=l),t.play()}catch(u){console.error("Failed to play positional audio:",u)}};if(o&&n&&o[n]){g(o[n]);return}xe(e,s).then(y=>{o&&n&&(o[n]=y),g(y)}).catch(y=>{console.error("Failed to load and play audio:",s,y)})}function Ae({screenAnchor:e=new ge(-.9,.9),targetLocalPos:t=new b(0,0,0),targetObject:s=null,label:o="btn",color:n=65280}={}){const i=[new b,new b],r=new Ke().setFromPoints(i),d=new ut({color:n}),c=new ft(r,d);c.set;let l=null;typeof document<"u"&&(l=document.createElement("button"),l.color=n,l.dimmed=!1,l.className="three-linebutton",l.style.position="absolute",l.style.padding="4px 12px",l.style.border="none",l.style.borderRadius="12px",l.style.backgroundColor=ie(n),l.style.color="#272727ff",l.style.fontFamily="sans-serif",l.style.fontSize="14px",l.style.cursor="pointer",l.style.transform="translate(-50%, -50%)",l.style.boxShadow="0 2px 2px rgba(255, 255, 255, 0.24)",l.style.userSelect="none",l.textContent=o,document.body.appendChild(l),l.addEventListener("mouseenter",()=>{l.style.backgroundColor=ie(Math.min(n*4,16777215))}),l.addEventListener("mouseleave",()=>{l.style.backgroundColor=l.dimmed?"#444444":ie(n)}));const g=new gt;let y=!0;const u=new b,f=new b,h=new b,m=new b,L=new b,S=new b,k=new b;let ce=null,B=null,Ne=0;function nt(M){if((Ne%30===0||!ce)&&(ce=document.querySelector("canvas.webgl"),ce&&(B=ce.getBoundingClientRect())),Ne++,u.set(e.x,e.y,.5),u.unproject(M),f.copy(u).sub(M.position).normalize(),h.copy(M.position).add(f.multiplyScalar(1)),s?(m.copy(t),s.localToWorld(m)):m.copy(t),L.copy(m).sub(M.position).normalize(),g.set(M.position,L),S.copy(m),s){const Y=g.intersectObject(s,!0);Y&&Y.length>0&&S.copy(Y[0].point)}const Ee=c.geometry.attributes.position;if(Ee.setXYZ(0,h.x,h.y,h.z),Ee.setXYZ(1,S.x,S.y,S.z),Ee.needsUpdate=!0,l&&B)if(k.copy(h).project(M),!y||k.z>1||k.z<-1||k.x<-1.2||k.x>1.2||k.y<-1.2||k.y>1.2)l.style.display="none";else{l.style.display="";const Y=(k.x*.5+.5)*B.width+B.left,rt=(-k.y*.5+.5)*B.height+B.top;l.style.left=`${Y}px`,l.style.top=`${rt}px`}}function it(M){y=M,c.visible=M,l&&(l.style.display=M?"":"none")}function st(){l&&l.parentElement&&(l.removeEventListener("mouseenter",null),l.removeEventListener("mouseleave",null),l.parentElement.removeChild(l),l=null),c.geometry&&c.geometry.dispose(),c.material&&c.material.dispose()}return{line:c,button:l,update:nt,setVisible:it,dispose:st}}const ve=1e3,H=new Ke,he=new Float32Array(ve*3),J=new Float32Array(ve*4),Ze=new Float32Array(ve);H.setAttribute("position",new We(he,3));H.setAttribute("color",new We(J,4));H.setAttribute("size",new We(Ze,1));const Pe=new pt({size:.1,vertexColors:!0,transparent:!0,opacity:.5,blending:ht}),Xt=new mt(H,Pe),T={pool:[],active:[],acquire(){let e;return this.pool.length>0?e=this.pool.pop():e={offset:[0,0,0],scale:[0,0],quaternion:[0,0,0,0],rotation:0,color:[1,1,1,1],blend:0,texture:0,live:0,scaleIncrease:0,opacityDecrease:0,colorFrom:[0,0,0],colorTo:[0,0,0],colorSpeed:0,colorProgress:0},this.active.push(e),e},release(e){const t=this.active.indexOf(e);t>-1&&(this.active.splice(t,1),this.pool.push(e))},getActiveCount(){return this.active.length},clear(){for(;this.active.length>0;)this.pool.push(this.active.pop())}},D={emitters:[],enabled:!0,visible:!0,initialize:()=>{const e={enabled:!1,position:new b(-.5,.3,-2),settings:{radius1:.02,radius2:.1,radiusHeight:.2,addTime:.02,elapsed:0,liveTimeFrom:1,liveTimeTo:1.5,opacityDecrease:.008,rotationFrom:.5,rotationTo:1,speedFrom:.003,speedTo:.006,scaleFrom:.1,scaleIncrease:.002,colorFrom:[.9,.9,.9],colorTo:[.5,.5,.5],colorSpeedFrom:1,colorSpeedTo:1,brightnessFrom:.5,brightnessTo:.9,opacity:.6,blend:.8,texture:.5}};D.emitters.push(e)},update:(e,t)=>{D.emitters.forEach(o=>{if(t!=="stop"?(o.enabled=!0,o.settings.addTime=t==="accel"?.01:.02,o.settings.speedFrom=t==="accel"?.005:.003,o.settings.speedTo=t==="accel"?.008:.006):o.enabled=!1,o.enabled){let n=0;for(o.settings.elapsed+=e,n=Math.floor(o.settings.elapsed/o.settings.addTime),o.settings.elapsed-=n*o.settings.addTime;n--&&!(T.getActiveCount()>=ve);){const i=T.acquire(),r=o.settings.radius1*Math.sqrt(Math.random()),d=2*Math.PI*Math.random(),c=o.position.x+r*Math.cos(d),l=o.position.z+r*Math.sin(d),g=o.settings.radius2*Math.sqrt(Math.random()),y=c+g*Math.cos(d),u=l+g*Math.sin(d),f=new b(y-c,o.settings.radiusHeight,u-l).normalize(),h=Math.random()*(o.settings.speedTo-o.settings.speedFrom)+o.settings.speedFrom;f.multiplyScalar(h);const m=Math.random()*(o.settings.brightnessTo-o.settings.brightnessFrom)+o.settings.brightnessFrom;i.offset[0]=c,i.offset[1]=o.position.y,i.offset[2]=l,i.scale[0]=o.settings.scaleFrom,i.scale[1]=o.settings.scaleFrom,i.quaternion[0]=f.x,i.quaternion[1]=f.y,i.quaternion[2]=f.z,i.quaternion[3]=3,i.rotation=Math.random()*(o.settings.rotationTo-o.settings.rotationFrom)+o.settings.rotationFrom,i.color[0]=1,i.color[1]=1,i.color[2]=1,i.color[3]=o.settings.opacity,i.blend=o.settings.blend,i.texture=o.settings.texture,i.live=Math.random()*(o.settings.liveTimeTo-o.settings.liveTimeFrom)+o.settings.liveTimeFrom,i.scaleIncrease=o.settings.scaleIncrease,i.opacityDecrease=o.settings.opacityDecrease,i.colorFrom[0]=o.settings.colorFrom[0]*m,i.colorFrom[1]=o.settings.colorFrom[1]*m,i.colorFrom[2]=o.settings.colorFrom[2]*m,i.colorTo[0]=o.settings.colorTo[0]*m,i.colorTo[1]=o.settings.colorTo[1]*m,i.colorTo[2]=o.settings.colorTo[2]*m,i.colorSpeed=Math.random()*(o.settings.colorSpeedTo-o.settings.colorSpeedFrom)+o.settings.colorSpeedFrom,i.colorProgress=0}}});const s=T.active;for(let o=s.length-1;o>=0;o--){const n=s[o];if(n.offset[0]+=n.quaternion[0],n.offset[1]+=n.quaternion[1],n.offset[2]+=n.quaternion[2],n.scale[0]+=n.scaleIncrease,n.scale[1]+=n.scaleIncrease,n.colorProgress+=n.colorSpeed,n.colorProgress>1&&(n.colorProgress=1),n.color[0]=n.colorFrom[0]+(n.colorTo[0]-n.colorFrom[0])*n.colorProgress,n.color[1]=n.colorFrom[1]+(n.colorTo[1]-n.colorFrom[1])*n.colorProgress,n.color[2]=n.colorFrom[2]+(n.colorTo[2]-n.colorFrom[2])*n.colorProgress,n.color[3]-=n.opacityDecrease,n.live-=e,n.live<=0||n.color[3]<=0){T.release(n);continue}const i=o*3;he[i]=n.offset[0],he[i+1]=n.offset[1],he[i+2]=n.offset[2];const r=o*4;J[r]=n.color[0],J[r+1]=n.color[1],J[r+2]=n.color[2],J[r+3]=n.color[3],Ze[o]=n.scale[0]}T.getActiveCount()>0&&(H.attributes.position.needsUpdate=!0,H.attributes.color.needsUpdate=!0,H.attributes.size.needsUpdate=!0)},getMesh:()=>Xt,dispose:()=>{T.clear(),H&&H.dispose(),Pe&&Pe.dispose(),D.emitters.length=0},getStats:()=>({activeParticles:T.getActiveCount(),pooledParticles:T.pool.length,totalAllocated:T.active.length+T.pool.length})};function Kt({emitters:e={},initialVisible:t=!1}={}){let s=t,o=null;const n=new Map;function i(){return o||(o=document.createElement("div"),o.id="audio-volume-panel",Object.assign(o.style,{position:"fixed",bottom:"10px",right:"10px",padding:"8px",background:"rgba(0,0,0,0.6)",color:"#fff",borderRadius:"6px",zIndex:9999,fontFamily:"monospace",fontSize:"12px",pointerEvents:"none",display:s?"":"none"}),document.body.appendChild(o),o)}function r(u){const f=document.createElement("div");f.dataset.pos=u,Object.assign(f.style,{display:"flex",alignItems:"center",marginBottom:"6px",pointerEvents:"auto",flexDirection:"row"});const h=document.createElement("div");h.className="vol-label",h.textContent=u,Object.assign(h.style,{width:"70px",textTransform:"capitalize"});const m=document.createElement("div");m.className="vol-bar-container",Object.assign(m.style,{width:"64px",height:"12px",background:"rgba(255,255,255,0.08)",borderRadius:"3px",display:"flex",alignItems:"center",overflow:"hidden",marginLeft:"8px",marginRight:"8px"});const L=document.createElement("div");L.className="vol-bar",Object.assign(L.style,{width:"0%",height:"100%",background:"#666",transition:"width 0.08s linear"});const S=u.toUpperCase();return V[S]!==void 0&&(L.style.background=ie(V[S])),m.appendChild(L),f.appendChild(h),f.appendChild(m),f}function d(u,f){if(!n.has(u)&&f?.getOutput()){const h=new yt(f,32);n.set(u,h)}return n.get(u)}function c(u,f){const h=d(u,f);if(!h)return 0;const m=h.getAverageFrequency()/255,L=f&&f.getVolume?f.getVolume():0;return m*L}function l(){const u=i();Object.entries(e).forEach(([f,h])=>{if(f==="mix")return;let m=u.querySelector(`[data-pos="${f}"]`);m||(m=r(f),u.appendChild(m));const L=c(f,h)*3,S=m.querySelector(".vol-bar");S.style.width=`${Math.max(0,Math.min(1,L))*100}%`}),o.style.display=s?"":"none"}function g(u){s=!!u,o&&(o.style.display=s?"":"none")}function y(){n.forEach(u=>{if(u&&u.analyser)try{u.analyser.disconnect()}catch(f){console.warn("Error disposing analyser:",f)}}),n.clear(),o&&o.parentElement&&(o.parentElement.removeChild(o),o=null)}return{update:l,setVisible:g,isVisible:()=>s,dispose:y}}function Qt({initialVisible:e=!1}={}){let t=e,s=null,o=0,n=performance.now(),i=0,r=0;function d(){return s||(s=document.createElement("div"),s.id="performance-stats",Object.assign(s.style,{position:"fixed",bottom:"10px",left:"10px",padding:"8px",background:"rgba(0,0,0,0.6)",color:"#fff",borderRadius:"6px",zIndex:9999,fontFamily:"monospace",fontSize:"12px",pointerEvents:"none",display:t?"":"none",minWidth:"120px"}),document.body.appendChild(s),s)}function c(){o++;const y=performance.now(),u=y-n;if(u>=1e3&&(i=Math.round(o*1e3/u),r=u/o,o=0,n=y),t){const f=d();let h="#00ff00";i<60&&(h="#ffff00"),i<30&&(h="#ff0000"),f.innerHTML=`
                <div style="margin-bottom: 4px;">
                    <span style="color: #888;">FPS:</span> 
                    <span style="color: ${h}; font-weight: bold;">${i}</span>
                </div>
                <div>
                    <span style="color: #888;">Frame:</span> 
                    <span>${r.toFixed(2)}ms</span>
                </div>
            `}}function l(y){t=!!y,s&&(s.style.display=t?"":"none")}function g(){s&&s.parentElement&&(s.parentElement.removeChild(s),s=null)}return{update:c,setVisible:l,isVisible:()=>t,dispose:g,getStats:()=>({fps:i,frameTime:r})}}bt.enabled=!1;var X=z.STOP,me=ne.MIX;const Re=Vt();if(!Re.available)throw U("WebGL Not Supported",Re.error,!0),new Error(Re.error);const Me=Nt();if(!Me.available)throw U("Web Audio Not Supported",Me.error,!0),new Error(Me.error);const N={modelsLoaded:!1,audioLoaded:!1,sceneReady:!1},Je=document.querySelector("canvas.webgl"),p=new xt;p.background=new Qe(10526880);p.fog=new vt(15716789,.05);const ae=new wt,se={Meters:!0,Emitters:!1},we=ae.addFolder("Audio");let ee=null;const le=ae.addFolder("Vehicle");let te=null,oe=null;const Yt=ae.addFolder("Performance"),Zt={"Show Stats":!1},Te=new Et,ue=new ze,Jt=new Ct;new Lt;const j=new fe(new St(10,10),new Ft({color:"#444444",metalness:0,roughness:.5}));j.receiveShadow=!0;j.rotation.x=-Math.PI*.5;p.add(j);const Oe=p.background?p.background.clone():new Qe(10526880);let I=null;const eo=["None",...Object.keys(Ye)],to={HDR:"None"};le.add(to,"HDR",eo).name("Level Select").onChange(e=>{if(e==="None"){I&&(ke(I),I=null),p.background=Oe.clone?Oe.clone():Oe,p.environment=null,j.visible=!0,Ue(null),p.fog&&(p.fog.color.set(15716789),p.fog.density=.05),typeof x.toneMappingExposure=="number"&&(x.toneMappingExposure=E.exposure),p.traverse(n=>{n.isMesh&&n.material&&(Array.isArray(n.material)?n.material.forEach(i=>i.needsUpdate=!0):n.material.needsUpdate=!0)}),console.log("[HDR Reset] Ambient",R.intensity,R.color.getHexString()),Q.forEach((n,i)=>console.log(`[HDR Reset] Dir${i}`,n.intensity,n.color.getHexString())),console.log("[HDR Reset] Hemi",w.intensity,w.color.getHexString(),w.groundColor.getHexString()),C.removeConvolutionReverb(),ye.Reverb="None",ee&&ee.updateDisplay();return}const t=Ye[e];if(!t)return;const s=typeof t=="string"?t:t.path,o=typeof t=="object"?t.reverb:null;Gt(Jt,s).then(n=>{if(I&&ke(I),n.mapping=Tt,I=n,p.background=n,p.environment=n,j.visible=!1,t.lighting&&Ue(t.lighting),o&&ye&&(ye.Reverb=o,ee)){ee.updateDisplay();const i=He[o];if(i){const{path:r,blend:d=.5,scalingFactor:c=1}=i;C.currentReverbBlend=d,C.currentReverbScalingFactor=c,xe(new ze,r).then(l=>{C.applyConvolutionReverb(l)}).catch(l=>{console.error("Failed to load reverb:",l),U("Reverb Load Failed",`Could not load reverb: ${l.message}`,!1)})}}}).catch(n=>{console.error("Failed to load HDR:",n),U("HDR Load Failed",`Could not load environment: ${n.message}`,!1)})});let v=new Xe;p.add(v);v.add(D.getMesh());const G=[];let a={mixerWheels:null,actWheelsRot:null,actTiresRot:null,mixerLights:null,actLights0:null,actLights1:null,actLights2:null,actLights3:null,actLights4:null,headLightL:null,headLightR:null,lightsFlipFlop:!0,lightsIntensity:3,lightsTimeScaleToggle:()=>{if(a.mixerLights)if(a.lightsFlipFlop){a.mixerLights.timeScale=1.5;for(let e=0;e<5;e++){const t=`actLights${e}`;a[t]&&(a[t].time=0)}a.lightsFlipFlop=!1}else{a.mixerLights.timeScale=-1.5;for(let e=0;e<5;e++){const t=`actLights${e}`;a[t]&&(a[t].time=a[t].getClip().duration-a[t].time)}a.lightsFlipFlop=!0}},lights:()=>{a.mixerLights&&(a.mixerLights.stopAllAction(),a.lightsTimeScaleToggle(),a.actLights0&&a.actLights0.play(),a.actLights1&&a.actLights1.play(),a.actLights2&&a.actLights2.play(),a.actLights3&&a.actLights3.play(),a.actLights4&&a.actLights4.play())}};async function oo(){const e=$t("Loading models...");try{e.update("Loading car model...");const[t,s,o]=await Promise.all([Se(Te,"./model/rx7/rx7.gltf"),Se(Te,"./model/rx7_wheels/rx7_wheels.gltf"),Se(Te,"./model/rx7_lights/rx7_lights.gltf")]);e.update("Setting up scene..."),t.scene.scale.set(1,1,1),v.add(t.scene),D.initialize(),s.scene.scale.set(1,1,1),s.scene.position.set(0,0,0),v.add(s.scene);const n=s.scene.clone();n.position.set(0,0,2.45),v.add(n);const i=s.scene.clone();i.position.set(0,0,2.45),i.scale.set(-1,1,1),v.add(i);const r=s.scene.clone();r.position.set(0,0,0),r.scale.set(-1,1,1),v.add(r),a.mixerWheels=new _e(new Dt(s.scene,n,i,r)),a.actWheelsRot=a.mixerWheels.clipAction(s.animations[0]),a.actTiresRot=a.mixerWheels.clipAction(s.animations[1]),o.scene.scale.set(1,1,1),v.add(o.scene),a.mixerLights=new _e(o.scene);for(let l=0;l<5;l++){const g=`actLights${l}`;a[g]=a.mixerLights.clipAction(o.animations[l]),a[g].setLoop(Wt),a[g].clampWhenFinished=!0}const{left:d,right:c}=Bt({intensity:a.lightsIntensity});a.headLightL=d,a.headLightR=c,v.add(a.headLightL),v.add(a.headLightL.target),v.add(a.headLightR),v.add(a.headLightR.target),le.add(a,"lights").name("Headlights"),no(t.scene),N.modelsLoaded=!0,e.remove(),console.log("✓ All models loaded successfully")}catch(t){e.remove(),console.error("Failed to load models:",t),U("Failed to Load Models",`Could not load required 3D models. Please check your connection and refresh the page.

Error: ${t.message}`,!1)}}function no(e){const t=Ae({screenAnchor:new ge(-.5,-.8),targetLocalPos:new b(0,.2,2.1),targetObject:e,label:"Intake",color:V.INTAKE}),s=Ae({screenAnchor:new ge(.5,-.8),targetLocalPos:new b(-.5,.3,-2),targetObject:e,label:"Exhaust",color:V.EXHAUST}),o=Ae({screenAnchor:new ge(0,-.8),targetLocalPos:new b(0,.1,-.2),targetObject:e,label:"Interior",color:V.INTERIOR});[t,s,o].forEach(i=>{p.add(i.line),G.push(i),i.button.addEventListener("click",()=>{ne[i.button.textContent.toUpperCase()]===me?(me=ne.MIX,G.forEach(r=>{r!==i&&(r.button.style.backgroundColor=ie(V[r.button.textContent.toUpperCase()]),r.button.style.color="#272727ff",r.line.visible=!0,r.button.dimmed=!1)}),se.Emitters&&q.forEach(r=>r.visible=!0)):(me=ne[i.button.textContent.toUpperCase()],G.forEach(r=>{if(r!==i){if(r.button.style.backgroundColor="#444444",r.button.style.color="#888888",r.line.visible=!1,r.button.dimmed=!0,se.Emitters){const d=r.button.textContent.toLowerCase(),c=q.get(d);c&&(c.visible=!1)}}else if(r.button.style.color="#272727ff",r.line.visible=!0,r.button.dimmed=!1,se.Emitters){const d=r.button.textContent.toLowerCase(),c=q.get(d);c&&(c.visible=!0)}}))})});const n={"Solo Buttons":!0};we.add(n,"Solo Buttons").onChange(i=>{t.setVisible(i),s.setVisible(i),o.setVisible(i)})}oo().then(()=>{Ie()}).catch(e=>{console.error("Critical error during model initialization:",e)});function Ie(){N.modelsLoaded&&N.audioLoaded&&!N.sceneReady&&(N.sceneReady=!0,console.log("✓ Scene fully initialized and ready"))}const w=new Mt(F.hemisphere.skyColor,F.hemisphere.groundColor,F.hemisphere.intensity);w.position.set(0,100,0);p.add(w);const R=new Rt(F.ambient.color,F.ambient.intensity);p.add(R);const Q=Ut([{color:F.directional[0].color,intensity:F.directional[0].intensity,position:[5,3,4]},{color:F.directional[1].color,intensity:F.directional[1].intensity,position:[8,3,-1]},{color:F.directional[2].color,intensity:F.directional[2].intensity,position:[-5,5,-5]}]);Q.forEach(e=>p.add(e));let E=null;function et(){E={ambient:{color:R.color.getHex(),intensity:R.intensity},hemi:{sky:w.color.getHex(),ground:w.groundColor.getHex(),intensity:w.intensity},directional:Q.map(e=>({color:e.color.getHex(),intensity:e.intensity})),fog:p.fog?{color:p.fog.color.getHex(),density:p.fog.density}:null,exposure:typeof x<"u"&&typeof x.toneMappingExposure=="number"?x.toneMappingExposure:1}}function tt(){E||et(),R.color.setHex(E.ambient.color),R.intensity=E.ambient.intensity,w.color.setHex(E.hemi.sky),w.groundColor.setHex(E.hemi.ground),w.intensity=E.hemi.intensity,Q.forEach((e,t)=>{e.color.setHex(E.directional[t].color),e.intensity=E.directional[t].intensity}),p.fog&&E.fog&&(p.fog.color.setHex(E.fog.color),p.fog.density=E.fog.density),E&&typeof x<"u"&&typeof x.toneMappingExposure=="number"&&(x.toneMappingExposure=E.exposure)}function Ue(e){if(!e){tt();return}e.ambient&&(e.ambient.color!==void 0&&R.color.setHex(e.ambient.color),e.ambient.intensity!==void 0&&(R.intensity=e.ambient.intensity)),e.hemisphere&&(e.hemisphere.skyColor!==void 0&&w.color.setHex(e.hemisphere.skyColor),e.hemisphere.groundColor!==void 0&&w.groundColor.setHex(e.hemisphere.groundColor),e.hemisphere.intensity!==void 0&&(w.intensity=e.hemisphere.intensity)),e.directional&&Array.isArray(e.directional)&&Q.forEach((t,s)=>{const o=e.directional[s];o&&(o.color!==void 0&&t.color.setHex(o.color),o.intensity!==void 0&&(t.intensity=o.intensity))})}const O={width:window.innerWidth,height:window.innerHeight},io=()=>{O.width=window.innerWidth,O.height=window.innerHeight,W.aspect=O.width/O.height,W.updateProjectionMatrix(),x.setSize(O.width,O.height),x.setPixelRatio(Math.min(window.devicePixelRatio,2))};window.addEventListener("resize",io);const W=new Ot(75,O.width/O.height,.1,100);W.position.set(4,2,3);p.add(W);const Ve=new kt(W,Je);Ve.target.set(0,.75,0);Ve.enableDamping=!0;const x=new At({canvas:Je});x.outputColorSpace=Pt;x.shadowMap.enabled=!0;x.shadowMap.type=It;x.setSize(O.width,O.height);x.setPixelRatio(Math.min(window.devicePixelRatio,2));et();tt();const $=new Ht;W.add($);const K=$.context,A={mix:new de($),intake:new de($),exhaust:new de($),interior:new de($)};console.log("Audio Emitters:",A);Object.entries(A).forEach(([e,t])=>{switch(v.add(t),e){case"intake":t.position.set(0,.2,2.1),t.setVolume(0),t.setDirectionalCone(Z.degToRad(P.innerAngle),Z.degToRad(P.outerAngle),P.outerGain);break;case"exhaust":t.position.set(-.5,.3,-2),t.setVolume(0),t.rotation.y=Math.PI,t.setDirectionalCone(Z.degToRad(P.innerAngle),Z.degToRad(P.outerAngle),P.outerGain);break;case"interior":t.position.set(0,.5,-.2),t.setVolume(0);break;case"mix":t.position.set(0,0,0),t.setVolume(1);break;default:t.position.set(0,0,0);break}});const C={buffers:{mix:{},intake:{ignitionOn:null,idle:null,ignitionOff:null},exhaust:{ignitionOn:null,idle:null,ignitionOff:null},interior:{ignitionOn:null,idle:null,ignitionOff:null}},currentEmitter:null,setEmitterVolumes(e){["intake","exhaust","interior"].forEach(s=>{const o=A[s];if(!o)return;const n=e===ne.MIX?Le.MIX:s===e?1:0,i=Le[s.toUpperCase()]!==void 0?Le[s.toUpperCase()]:1,r=Math.max(0,Math.min(1,n*i)),d=o.getVolume();d<r?o.setVolume(Math.min(r,d+.2)):d>r&&o.setVolume(Math.max(r,d-.2))}),A.mix.setVolume(0)},ignitionOn:()=>{K.state==="suspended"&&K.resume().then(()=>{console.log("Audio context enabled via user interaction")}).catch(e=>{console.error("Failed to resume audio context:",e)}),Object.entries(A).forEach(([e,t])=>{e!=="mix"&&Fe(ue,t,`./audio/${e}/ignitionOn.ogg`,{store:C.buffers[e],storeKey:"ignitionOn",loop:!1,onEnded:()=>{Fe(ue,t,`./audio/${e}/idle.ogg`,{store:C.buffers[e],storeKey:"idle",loop:!0,onEnded:()=>{}})}})}),X=z.ACCEL,a.mixerWheels&&(a.mixerWheels.stopAllAction(),a.actWheelsRot.play(),a.actTiresRot.play(),a.mixerWheels.timeScale=.01),te&&te.hide(),oe&&oe.show()},ignitionOff:()=>{Object.entries(A).forEach(([e,t])=>{e!=="mix"&&Fe(ue,t,`./audio/${e}/ignitionOff.ogg`,{store:C.buffers[e],storeKey:"ignitionOff",loop:!1,onEnded:()=>{t.stop()}})}),X=z.DECEL,te&&te.show(),oe&&oe.hide()},load(){const e=this,t=[];Object.keys(e.buffers).forEach(s=>{Object.keys(e.buffers[s]).forEach(o=>{const n=xe(ue,`./audio/${s}/${o}.ogg`).then(i=>{e.buffers[s][o]=i}).catch(i=>{console.error(`Failed to load audio ${s}/${o}:`,i)});t.push(n)})}),Promise.all(t).then(()=>{N.audioLoaded=!0,console.log("✓ All audio files loaded"),Ie()}).catch(()=>{N.audioLoaded=!0,U("Audio Load Warning","Some audio files failed to load. The experience may be incomplete.",!1),Ie()})},applyConvolutionReverb(e){const t=this.currentReverbBlend??.5;Object.values(A).forEach(s=>{if(s._reverbNodes){try{const{dryGain:c,wetGain:l,convolver:g}=s._reverbNodes;c.disconnect(),l.disconnect(),g.disconnect()}catch{}s._reverbNodes=null}const o=$.context,n=o.createConvolver();n.buffer=e;const i=o.createGain(),r=o.createGain();i.gain.value=t*this.currentReverbScalingFactor,r.gain.value=(1-t)*this.currentReverbScalingFactor;const d=s.panner;if(!d){console.warn("PositionalAudio panner node missing; cannot apply reverb graph");return}d.connect(r),r.connect(o.destination),d.connect(n),n.connect(i),i.connect(o.destination),s._reverbNodes={convolver:n,wetGain:i,dryGain:r}})},removeConvolutionReverb(){Object.values(A).forEach(e=>{if(e._reverbNodes){try{const{dryGain:t,wetGain:s,convolver:o}=e._reverbNodes;t.disconnect(),s.disconnect(),o.disconnect()}catch(t){console.warn("Error disconnecting reverb nodes:",t)}e._reverbNodes=null}}),this.currentReverbBlend=null,this.currentReverbScalingFactor=null}};C.load();const He={Garage:{path:"./audio/ir/garage.ogg",blend:.8,scalingFactor:.33},Outdoors:{path:"./audio/ir/outdoors.ogg",blend:.6,scalingFactor:.2}},ye={Reverb:"None"};ee=we.add(ye,"Reverb",["None",...Object.keys(He)]).name("Conv. Reverb").onChange(e=>{if(e==="None"){C.removeConvolutionReverb();return}const t=He[e];if(!t)return;const{path:s,blend:o=.5,scalingFactor:n=1}=t;C.currentReverbBlend=o,C.currentReverbScalingFactor=n,xe(new ze,s).then(i=>{C.applyConvolutionReverb(i)}).catch(i=>{console.error("Failed to load reverb:",i),U("Reverb Load Failed",`Could not load reverb preset: ${i.message}`,!1)})});const _=Kt({emitters:A,initialVisible:!0});we.add(se,"Meters").onChange(e=>_.setVisible(e));const re=Qt({initialVisible:!1});Yt.add(Zt,"Show Stats").onChange(e=>re.setVisible(e));const q=new Map;Object.entries(A).forEach(([e,t])=>{if(e==="mix")return;const s={color:V[e.toUpperCase()]||16776960,size:.4};e==="intake"?(s.showCone=!0,s.coneAngle=P.innerAngle,s.coneDirection=new b(0,0,1)):e==="exhaust"&&(s.showCone=!0,s.coneAngle=P.innerAngle,s.coneDirection=new b(0,0,-1));const o=jt(t,s);o.visible=!1,v.add(o),q.set(e,o)});we.add(se,"Emitters").onChange(e=>{q.forEach(t=>t.visible=e)});const je=["Mazda RX-7 FD"];le.add({car:je[0]},"car",je).name("Car").onChange(e=>{});te=le.add(C,"ignitionOn").name("Ignition On");oe=le.add(C,"ignitionOff").name("Ignition Off").hide();function so(){console.log("Cleaning up resources..."),be&&(cancelAnimationFrame(be),be=null),G.forEach(e=>{e&&e.dispose&&e.dispose()}),G.length=0,q.forEach(e=>{pe(e)}),q.clear(),_&&_.dispose&&_.dispose(),re&&re.dispose&&re.dispose(),Object.values(A).forEach(e=>{_t(e)}),D&&D.dispose&&D.dispose(),I&&(ke(I),I=null),v&&pe(v),j&&pe(j),a.mixerWheels&&(a.mixerWheels.stopAllAction(),a.mixerWheels=null),a.mixerLights&&(a.mixerLights.stopAllAction(),a.mixerLights=null),w&&p.remove(w),R&&p.remove(R),Q.forEach(e=>{p.remove(e),e.dispose()}),x&&x.dispose(),ae&&ae.destroy(),console.log("Cleanup complete")}let be=null,De=!document.hidden;document.addEventListener("visibilitychange",()=>{De=!document.hidden,De?(console.log("Tab visible - resuming simulation"),K&&K.state==="suspended"&&K.resume().catch(e=>{console.warn("Failed to resume audio context:",e)})):(console.log("Tab hidden - pausing heavy computations"),K.suspend())});window.addEventListener("beforeunload",()=>{so()});const ro=new zt;let Be=0;const ot=()=>{const e=ro.getElapsedTime(),t=e-Be;if(Be=e,De){if(a.mixerWheels)switch(a.mixerWheels.update(t),X){case z.ACCEL:for(;a.mixerWheels.timeScale<1;)a.mixerWheels.timeScale+=t,a.mixerWheels.timeScale>=1&&(a.mixerWheels.timeScale=1,X=z.DRIVE);break;case z.DECEL:for(;a.mixerWheels.timeScale>0;)a.mixerWheels.timeScale-=t,a.mixerWheels.timeScale<=0&&(a.mixerWheels.timeScale=0,X=z.STOP,a.mixerWheels.stopAllAction());break}if(a.mixerLights&&(a.mixerLights.update(t),a.actLights0&&a.headLightL&&a.headLightR)){const s=a.lightsIntensity-a.actLights0.time/a.actLights0.getClip().duration*a.lightsIntensity;a.headLightL.intensity=a.headLightR.intensity=s}v.position.z=Math.sin(e*2)*.0125,D.update(t,X),G.length>0&&G.forEach(s=>{try{s.update(W)}catch{}}),C.setEmitterVolumes(me),_&&_.update&&_.update()}Ve.update(),re.update(),x.render(p,W),be=window.requestAnimationFrame(ot)};ot();
//# sourceMappingURL=index-Bo17xfEg.js.map
